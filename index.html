<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F&B Inventory Manager</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Cleaner UI Tweaks */
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .soft-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; height: auto !important; overflow: visible !important; }
            #root, main, .flex, .h-screen { height: auto !important; overflow: visible !important; display: block !important; }
            .sidebar { display: none !important; }
            .card-print { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; overflow: visible !important; }
            .overflow-x-auto, .overflow-y-auto { overflow: visible !important; }
        }

        /* Toast Animation */
        @keyframes slideInBottom {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Mock Data & Constants ---
        const initialData = [
            { id: "A101", name: "Beras Pandan Wangi", category: "Bahan Kering", stock: 25, unit: "kg", price: 14000, minStock: 10 },
            { id: "B205", name: "Daging Sapi Slice", category: "Fresh Food", stock: 5, unit: "kg", price: 120000, minStock: 8 },
            { id: "C312", name: "Minyak Goreng", category: "Bahan Kering", stock: 12, unit: "liter", price: 18000, minStock: 10 },
            { id: "D404", name: "Paper Cup 12oz", category: "Packaging", stock: 800, unit: "pcs", price: 500, minStock: 200 },
            { id: "E510", name: "Kopi Arabica Blend", category: "Bahan Kering", stock: 3, unit: "kg", price: 250000, minStock: 5 },
            { id: "F609", name: "Susu UHT Full Cream", category: "Dairy", stock: 24, unit: "liter", price: 19000, minStock: 12 },
        ];

        const CATEGORIES = ["Fresh Food", "Bahan Kering", "Frozen Food", "Dairy", "Sayuran", "Packaging", "Cleaning"];
        const UNITS = ["kg", "gram", "liter", "ml", "pcs", "pack", "karton", "ikat", "butir"];

        // --- Mock Data for Products ---
        const initialProducts = [
            { 
                id: "P001", 
                name: "Kopi Susu Gula Aren", 
                sellingPrice: 18000,
                overhead: 500,
                recipe: [
                    { itemId: "E510", qty: 0.02 }, // 20g Kopi
                    { itemId: "F609", qty: 0.15 }, // 150ml Susu
                    { itemId: "D404", qty: 1 }     // 1 Cup
                ]
            }
        ];

        // --- Components ---

        // Reliable Icon Component
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = React.useRef(null);
            
            React.useEffect(() => {
                if (ref.current && window.lucide) {
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: {
                            width: size,
                            height: size,
                            class: `lucide lucide-${name}`
                        }
                    });
                }
            }, [name, size]);

            return (
                <span ref={ref} className={`inline-flex items-center justify-center ${className}`}>
                    <i data-lucide={name}></i>
                </span>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-[0_2px_12px_-2px_rgba(0,0,0,0.06)] border border-slate-100 p-6 ${className}`}>
                {children}
            </div>
        );

        // Toast Component
        const ToastContext = React.createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts([...toasts, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            };

            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`
                                pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border animate-[slideInBottom_0.3s_ease-out]
                                ${toast.type === 'success' ? 'bg-white border-emerald-100 text-emerald-800' : ''}
                                ${toast.type === 'error' ? 'bg-white border-rose-100 text-rose-800' : ''}
                                ${toast.type === 'info' ? 'bg-slate-800 text-white border-transparent' : ''}
                            `} style={{ minWidth: '300px' }}>
                                <div className={`p-1 rounded-full ${toast.type === 'success' ? 'bg-emerald-100' : toast.type === 'error' ? 'bg-rose-100' : 'bg-slate-700'}`}>
                                    <Icon name={toast.type === 'success' ? 'check' : toast.type === 'error' ? 'alert-circle' : 'info'} size={16} />
                                </div>
                                <span className="text-sm font-medium">{toast.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => React.useContext(ToastContext);

        // Login Component
        const LoginScreen = ({ onLogin }) => {
            const [selectedRole, setSelectedRole] = useState(null);
            const [pin, setPin] = useState("");
            const [error, setError] = useState("");
            const [showPin, setShowPin] = useState(false);
            
            // Feature Toggles State
            const [selectedFeatures, setSelectedFeatures] = useState({
                list: true,
                products: true,
                hpp: true, // New feature
                usage: true,
                restock: true,
                finance: true
            });

            const handleFeatureToggle = (key) => {
                setSelectedFeatures(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const handlePinSubmit = (e) => {
                e.preventDefault();
                // Extract active features
                const activeFeatures = Object.keys(selectedFeatures).filter(k => selectedFeatures[k]);
                
                // Simple hardcoded PINs for demo purposes
                if (selectedRole === 'owner' && pin === '1234') {
                    onLogin('owner', activeFeatures);
                } else if (selectedRole === 'ceo' && pin === '0000') {
                    onLogin('ceo', activeFeatures);
                } else {
                    setError("PIN Salah! Silakan coba lagi.");
                    setPin("");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
                        <div className="p-8 text-center border-b border-gray-100">
                            <div className="inline-flex p-3 bg-emerald-100 text-emerald-600 rounded-xl mb-4">
                                <Icon name="chef-hat" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">KitchenPro Login</h1>
                            <p className="text-gray-500 mt-2">Sistem Manajemen Inventaris Profesional</p>
                        </div>
                        
                        {!selectedRole ? (
                            <div className="p-8 space-y-4">
                                <p className="text-center text-sm text-gray-500 mb-4">Pilih otoritas akses:</p>
                                <button onClick={() => setSelectedRole('owner')} className="w-full p-4 flex items-center gap-4 border-2 border-gray-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl transition-all group text-left">
                                    <div className="p-3 bg-blue-100 text-blue-600 rounded-full group-hover:scale-110 transition-transform">
                                        <Icon name="shield-check" />
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">Owner / Administrator</div>
                                        <div className="text-xs text-gray-500">Akses Penuh (PIN: 1234)</div>
                                    </div>
                                </button>
                                <button onClick={() => setSelectedRole('ceo')} className="w-full p-4 flex items-center gap-4 border-2 border-gray-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl transition-all group text-left">
                                    <div className="p-3 bg-purple-100 text-purple-600 rounded-full group-hover:scale-110 transition-transform">
                                        <Icon name="user-check" />
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">Staff / Operator</div>
                                        <div className="text-xs text-gray-500">Akses Terbatas (PIN: 0000)</div>
                                    </div>
                                </button>
                            </div>
                        ) : (
                            <div className="p-8">
                                <button onClick={() => { setSelectedRole(null); setError(""); setPin(""); }} className="text-sm text-gray-500 flex items-center gap-1 mb-6 hover:text-emerald-600">
                                    <Icon name="arrow-left" size={16} /> Kembali
                                </button>
                                
                                <h2 className="text-xl font-bold text-center mb-6">
                                    Masukan PIN {selectedRole === 'owner' ? 'Owner' : 'Staff'}
                                </h2>

                                <form onSubmit={handlePinSubmit} className="space-y-4">
                                    <div className="relative">
                                        <input 
                                            type={showPin ? "text" : "password"} 
                                            autoFocus
                                            maxLength={4}
                                            className="w-full text-center text-3xl tracking-[1em] font-bold p-4 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none transition-colors"
                                            value={pin}
                                            onChange={e => { setPin(e.target.value.replace(/[^0-9]/g, '')); setError(""); }}
                                            placeholder="••••"
                                        />
                                        <button 
                                            type="button" 
                                            onClick={() => setShowPin(!showPin)}
                                            className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 p-2"
                                        >
                                            <Icon name={showPin ? "eye-off" : "eye"} size={20} />
                                        </button>
                                    </div>
                                    
                                    {error && <div className="text-rose-500 text-sm text-center font-medium animate-pulse">{error}</div>}

                                    {/* Feature Toggles */}
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mt-4">
                                        <div className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="sliders" size={12} /> Pilih Fitur Aktif
                                        </div>
                                        <div className="space-y-2">
                                            {[
                                                { id: 'list', label: 'Stok Bahan', icon: 'package' },
                                                { id: 'products', label: 'Menu Resep', icon: 'coffee' },
                                                { id: 'hpp', label: 'Kalkulator HPP', icon: 'calculator' },
                                                { id: 'usage', label: 'Pemakaian Bahan', icon: 'clipboard-minus' },
                                                { id: 'restock', label: 'Pengadaan Stok', icon: 'shopping-cart' },
                                                { id: 'finance', label: 'Keuangan', icon: 'banknote', restricted: selectedRole !== 'owner' }
                                            ].map(feat => (
                                                !feat.restricted && (
                                                    <label key={feat.id} className="flex items-center gap-3 cursor-pointer group">
                                                        <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${selectedFeatures[feat.id] ? 'bg-emerald-500 border-emerald-500' : 'bg-white border-slate-300'}`}>
                                                            {selectedFeatures[feat.id] && <Icon name="check" size={12} className="text-white" />}
                                                        </div>
                                                        <input 
                                                            type="checkbox" 
                                                            className="hidden" 
                                                            checked={selectedFeatures[feat.id]} 
                                                            onChange={() => handleFeatureToggle(feat.id)}
                                                        />
                                                        <span className={`text-sm ${selectedFeatures[feat.id] ? 'text-slate-700 font-medium' : 'text-slate-400'}`}>
                                                            {feat.label}
                                                        </span>
                                                    </label>
                                                )
                                            ))}
                                        </div>
                                    </div>

                                    <Button type="submit" className="w-full justify-center py-3 text-lg mt-4">
                                        Masuk Sistem
                                    </Button>
                                </form>
                            </div>
                        )}

                        <div className="bg-gray-50 p-4 text-center text-xs text-gray-400">
                            &copy; 2025 KitchenPro Inventory System v2.0
                        </div>
                    </div>
                </div>
            );
        };

        // Chart Component Wrapper
        const ChartComponent = ({ type, data, options, height = 250 }) => {
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                    
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            ...options
                        }
                    });
                }
                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [data, options, type]);

            return (
                <div style={{ height: height, width: '100%' }}>
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        };

        const Button = ({ onClick, children, variant = "primary", className = "", type = "button", disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm hover:shadow-md",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:border-gray-300",
                danger: "bg-rose-50 text-rose-600 hover:bg-rose-100 border border-transparent",
                outline: "border border-gray-300 text-gray-600 hover:bg-gray-50",
                ghost: "text-gray-500 hover:bg-gray-100 hover:text-gray-700"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Badge = ({ children, type = "default" }) => {
            const styles = {
                default: "bg-gray-100 text-gray-700 border border-gray-200",
                success: "bg-emerald-50 text-emerald-700 border border-emerald-100",
                warning: "bg-amber-50 text-amber-700 border border-amber-100",
                danger: "bg-rose-50 text-rose-700 border border-rose-100",
                info: "bg-blue-50 text-blue-700 border border-blue-100"
            };
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[type]}`}>
                    {children}
                </span>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center p-6 border-b sticky top-0 bg-white z-10">
                            <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full transition-colors">
                                <i data-lucide="x" className="w-5 h-5 text-gray-500"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
                // --- Helpers ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(number);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

        const generateId = () => {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            return Array.from({length: 4}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        };

        const InventoryList = ({ inventory, products, searchTerm, setSearchTerm, user, canEdit, setEditingItem, setShowFormModal, handleDelete, setInventory, setUsageLog, usageLog, showToast, formatRupiah, setView }) => {
            const [filterMenuId, setFilterMenuId] = useState("all");
            const [opnameItem, setOpnameItem] = useState(null); // Item being adjusted
            const [opnameActual, setOpnameActual] = useState("");

            const handleOpnameSubmit = (e) => {
                e.preventDefault();
                if (!opnameItem) return;
                
                const actualStock = parseFloat(opnameActual);
                if (isNaN(actualStock) || actualStock < 0) return showToast("Stok fisik tidak valid", 'error');

                const systemStock = opnameItem.stock;
                const variance = actualStock - systemStock;

                if (variance === 0) {
                    showToast("Stok sudah sesuai (Tidak ada selisih)", 'info');
                    setOpnameItem(null);
                    return;
                }

                // 1. Adjust Stock
                setInventory(inventory.map(i => i.id === opnameItem.id ? { ...i, stock: actualStock } : i));

                // 2. Log Variance as Usage/Adjustment
                const log = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    itemId: opnameItem.id,
                    itemName: opnameItem.name,
                    amount: Math.abs(variance),
                    unit: opnameItem.unit,
                    reason: variance < 0 ? "Stok Opname (Loss/Hilang)" : "Stok Opname (Surplus/Lebih)",
                    cost: Math.abs(variance) * opnameItem.price
                };
                setUsageLog([log, ...usageLog]);

                showToast(`Stok Opname berhasil! Selisih: ${variance} ${opnameItem.unit}`, variance < 0 ? 'warning' : 'success');
                setOpnameItem(null);
                setOpnameActual("");
            };

            const filtered = useMemo(() => {
                const term = searchTerm.toLowerCase();
                const matchingProductIds = new Set();
                
                // Filter Logic:
                // 1. If filterMenuId is set, ONLY show ingredients from that menu
                // 2. If search term is present, search by name/category OR product name
                
                let filteredInventory = inventory;

                if (filterMenuId !== "all") {
                    const targetProduct = products.find(p => p.id === filterMenuId);
                    if (targetProduct) {
                        const ingredientIds = new Set(targetProduct.recipe.map(r => r.itemId));
                        filteredInventory = filteredInventory.filter(i => ingredientIds.has(i.id));
                    }
                }

                if (term) {
                    products.forEach(p => {
                        if (p.name.toLowerCase().includes(term)) {
                            p.recipe.forEach(r => matchingProductIds.add(r.itemId));
                        }
                    });

                    filteredInventory = filteredInventory.filter(i => 
                        i.name.toLowerCase().includes(term) || 
                        i.category.toLowerCase().includes(term) ||
                        matchingProductIds.has(i.id)
                    );
                }

                return filteredInventory;
            }, [inventory, products, searchTerm, filterMenuId]);
            
            const [showColMenu, setShowColMenu] = useState(false);
            const [cols, setCols] = useState({
                category: true,
                price: true,
                stock: true,
                status: true,
                usedIn: true,
                action: true
            });

            const toggleCol = (key) => setCols({ ...cols, [key]: !cols[key] });

            return (
                <div className="space-y-6">
                    {/* Print Header */}
                    <div className="hidden print-only mb-6 border-b pb-4">
                        <div className="flex justify-between items-end">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">Laporan Stok Opname</h1>
                                <p className="text-gray-500 mt-1">KitchenPro Inventory System</p>
                            </div>
                            <div className="text-right text-sm text-gray-600">
                                <p>Tanggal: {new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p>User: {user?.name}</p>
                            </div>
                        </div>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 items-center no-print">
                        {/* 1. Search */}
                        <div className="relative flex-1 w-full md:w-auto">
                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
                            <input 
                                type="text" placeholder="Cari bahan, kategori, menu..." 
                                className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-white shadow-sm"
                                value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>

                        {/* 2. Menu Filter */}
                        <select 
                            className="w-full md:w-auto p-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm text-sm"
                            value={filterMenuId} onChange={e => setFilterMenuId(e.target.value)}
                        >
                            <option value="all">Semua Menu</option>
                            {products.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>

                        {/* 3. Button: Tambah Bahan */}
                        {canEdit && (
                            <Button onClick={() => { setEditingItem({}); setShowFormModal(true); }} className="w-full md:w-auto justify-center">
                                <Icon name="plus" className="w-4 h-4" /> 
                                <span className="hidden sm:inline">Tambah Bahan</span>
                                <span className="sm:hidden">Tambah</span>
                            </Button>
                        )}

                        {/* 4. Button: Catat Pemakaian */}
                        <Button className="w-full md:w-auto justify-center bg-orange-500 hover:bg-orange-600 text-white shadow-orange-200" onClick={() => setView('usage')}>
                            <Icon name="clipboard-minus" className="w-4 h-4" /> 
                            <span className="hidden sm:inline">Catat Pemakaian</span>
                            <span className="sm:hidden">Pakai</span>
                        </Button>

                        {/* 5. Button: Print */}
                        <Button variant="secondary" onClick={() => window.print()} className="w-full md:w-auto justify-center px-3" title="Print Laporan">
                            <Icon name="printer" className="w-4 h-4" />
                            <span className="hidden lg:inline ml-2">Print</span>
                        </Button>

                        {/* 6. Button: Atur Kolom */}
                        <div className="relative w-full md:w-auto">
                            <Button variant="secondary" onClick={() => setShowColMenu(!showColMenu)} className="w-full justify-center px-3" title="Atur Kolom">
                                <Icon name="columns" className="w-4 h-4" /> 
                                <span className="hidden lg:inline ml-2">Kolom</span>
                            </Button>
                            {showColMenu && (
                                <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 p-2 z-20 flex flex-col gap-1">
                                    <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" checked={cols.category} onChange={() => toggleCol('category')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                        <span className="text-sm">Kategori</span>
                                    </label>
                                    <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" checked={cols.price} onChange={() => toggleCol('price')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                        <span className="text-sm">Harga</span>
                                    </label>
                                    <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" checked={cols.stock} onChange={() => toggleCol('stock')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                        <span className="text-sm">Stok Fisik</span>
                                    </label>
                                    <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" checked={cols.status} onChange={() => toggleCol('status')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                        <span className="text-sm">Status</span>
                                    </label>
                                    <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" checked={cols.usedIn} onChange={() => toggleCol('usedIn')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                        <span className="text-sm">Menu</span>
                                    </label>
                                    <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                        <input type="checkbox" checked={cols.action} onChange={() => toggleCol('action')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                        <span className="text-sm">Aksi</span>
                                    </label>
                                </div>
                            )}
                        </div>
                    </div>

                    {showColMenu && <div className="fixed inset-0 z-10" onClick={() => setShowColMenu(false)}></div>}

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden card-print">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50/50 text-slate-600 border-b border-slate-100">
                                    <tr>
                                        <th className="p-4 font-semibold">Nama Bahan</th>
                                        {cols.category && <th className="p-4 font-semibold">Kategori</th>}
                                        {cols.price && <th className="p-4 font-semibold no-print">Harga/Unit</th>}
                                        {cols.stock && <th className="p-4 font-semibold text-center">Stok Fisik</th>}
                                        <th className="p-4 font-semibold text-center hidden print-only">Cek Fisik</th>
                                        {cols.status && <th className="p-4 font-semibold text-center no-print">Status</th>}
                                        {cols.usedIn && <th className="p-4 font-semibold no-print">Menu</th>}
                                        {cols.action && canEdit && <th className="p-4 font-semibold text-right no-print">Aksi</th>}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {filtered.length === 0 ? (
                                        <tr>
                                            <td colSpan="7" className="p-12 text-center text-slate-400">
                                                <div className="flex flex-col items-center gap-2">
                                                    <Icon name="search-x" size={48} className="opacity-20" />
                                                    <p>Tidak ada bahan yang ditemukan.</p>
                                                </div>
                                            </td>
                                        </tr>
                                    ) : filtered.map(item => (
                                        <tr key={item.id} className="hover:bg-slate-50/50 transition-colors group">
                                            <td className="p-4">
                                                <div className="font-medium text-slate-900 group-hover:text-emerald-700 transition-colors">{item.name}</div>
                                                <div className="text-xs text-slate-400 font-mono mt-0.5">ID: {item.id}</div>
                                            </td>
                                            {cols.category && <td className="p-4"><Badge>{item.category}</Badge></td>}
                                            {cols.price && <td className="p-4 text-slate-600 no-print">{formatRupiah(item.price)} <span className="text-slate-400">/{item.unit}</span></td>}
                                            {cols.stock && (
                                                <td className="p-4 text-center">
                                                    <span className={`font-bold text-lg ${item.stock <= item.minStock ? 'text-rose-600' : 'text-slate-700'}`}>
                                                        {parseFloat(item.stock).toLocaleString('id-ID', { maximumFractionDigits: 3 })}
                                                    </span>
                                                    <span className="text-xs text-slate-400 ml-1">{item.unit}</span>
                                                </td>
                                            )}
                                            <td className="p-4 border-b hidden print-only border-slate-200">
                                                <div className="h-6 w-24 border-b border-slate-400 mx-auto"></div>
                                            </td>
                                            {cols.status && (
                                                <td className="p-4 text-center no-print">
                                                    {item.stock <= item.minStock ? 
                                                        <Badge type="danger">Low Stock</Badge> : 
                                                        <Badge type="success">Tersedia</Badge>
                                                    }
                                                </td>
                                            )}
                                            {cols.usedIn && (
                                                <td className="p-4 no-print text-sm text-gray-600">
                                                    {(() => {
                                                        const usedIn = products.filter(p => p.recipe.some(r => r.itemId === item.id)).map(p => p.name);
                                                        return usedIn.length > 0 ? (
                                                            <div className="flex flex-wrap gap-1">
                                                                {usedIn.slice(0, 3).map((name, i) => (
                                                                    <span key={i} className="inline-block px-2 py-0.5 bg-gray-100 text-gray-600 text-[10px] rounded-full border border-gray-200">
                                                                        {name}
                                                                    </span>
                                                                ))}
                                                                {usedIn.length > 3 && (
                                                                    <span className="inline-block px-2 py-0.5 bg-gray-50 text-gray-500 text-[10px] rounded-full border border-gray-100 italic">
                                                                        +{usedIn.length - 3} lainnya
                                                                    </span>
                                                                )}
                                                            </div>
                                                        ) : <span className="text-gray-400 text-xs italic">-</span>;
                                                    })()}
                                                </td>
                                            )}
                                            {cols.action && canEdit && (
                                                <td className="p-4 text-right no-print">
                                                    <div className="flex justify-end gap-2">
                                                        <Button variant="secondary" className="p-2 h-8 w-8 justify-center" onClick={() => { setEditingItem(item); setShowFormModal(true); }}>
                                                            <Icon name="edit-2" size={14} />
                                                        </Button>
                                                        <Button variant="secondary" className="p-2 h-8 w-8 justify-center text-rose-600 hover:bg-rose-50 hover:border-rose-200" onClick={() => handleDelete(item.id)}>
                                                            <Icon name="trash-2" size={14} />
                                                        </Button>
                                                    </div>
                                                </td>
                                            )}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Opname Modal */}
                    <Modal isOpen={!!opnameItem} onClose={() => setOpnameItem(null)} title="Stok Opname (Penyesuaian Fisik)">
                        {opnameItem && (
                            <form onSubmit={handleOpnameSubmit} className="space-y-4">
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                                    <div className="flex justify-between mb-1">
                                        <span className="text-sm text-blue-800">Nama Bahan:</span>
                                        <span className="font-bold text-blue-900">{opnameItem.name}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-sm text-blue-800">Stok di Sistem:</span>
                                        <span className="font-bold text-blue-900">{opnameItem.stock} {opnameItem.unit}</span>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium mb-1">Stok Fisik (Aktual)</label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="number" 
                                            step="0.001" 
                                            autoFocus
                                            required 
                                            className="flex-1 p-3 border-2 border-emerald-500 rounded-lg text-lg font-bold text-emerald-700 outline-none" 
                                            value={opnameActual} 
                                            onChange={e => setOpnameActual(e.target.value)} 
                                            placeholder="0"
                                        />
                                        <div className="flex items-center px-4 bg-gray-100 rounded-lg font-medium text-gray-500">
                                            {opnameItem.unit}
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-2">
                                        * Jika stok fisik lebih kecil dari sistem, selisih akan dicatat sebagai "Loss/Waste".<br/>
                                        * Jika lebih besar, akan dicatat sebagai "Surplus".
                                    </p>
                                </div>

                                <div className="pt-4 flex gap-2">
                                    <Button type="submit" className="flex-1 justify-center">Simpan Perubahan</Button>
                                    <Button variant="secondary" onClick={() => setOpnameItem(null)}>Batal</Button>
                                </div>
                            </form>
                        )}
                    </Modal>
                </div>
            );
        };

                const ItemForm = ({ editingItem, handleSaveItem, setShowFormModal }) => {
            const [form, setForm] = useState(editingItem.id ? editingItem : {
                name: '', category: 'Bahan Kering', stock: 0, unit: 'kg', price: 0, minStock: 5
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                handleSaveItem({ ...form, stock: parseFloat(form.stock), price: parseFloat(form.price), minStock: parseFloat(form.minStock) });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium mb-1">Nama Bahan</label>
                        <input type="text" required className="w-full p-2 border rounded-lg" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Kategori</label>
                            <select className="w-full p-2 border rounded-lg" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                                {CATEGORIES.map(c => <option key={c}>{c}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Satuan</label>
                            <select className="w-full p-2 border rounded-lg" value={form.unit} onChange={e => setForm({...form, unit: e.target.value})}>
                                {UNITS.map(u => <option key={u}>{u}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Stok Awal</label>
                            <input type="number" step="0.001" required className="w-full p-2 border rounded-lg" value={form.stock} onChange={e => setForm({...form, stock: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Min. Stok (Alert)</label>
                            <input type="number" step="0.001" required className="w-full p-2 border rounded-lg" value={form.minStock} onChange={e => setForm({...form, minStock: e.target.value})} />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1">Harga per Unit (IDR)</label>
                        <input type="number" required className="w-full p-2 border rounded-lg" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                    </div>
                    <div className="pt-4 flex gap-2">
                        <Button type="submit" className="flex-1 justify-center">Simpan</Button>
                        <Button variant="secondary" onClick={() => setShowFormModal(false)}>Batal</Button>
                    </div>
                </form>
            );
        };

                const UsageView = ({ inventory, user, handleRecordUsage, showToast, setView, usageLog }) => {
            const [selectedItemId, setSelectedItemId] = useState("");
            const [filterText, setFilterText] = useState(""); // Search state
            const [isOpen, setIsOpen] = useState(false); // Dropdown visibility
            const [amount, setAmount] = useState("");
            const [reason, setReason] = useState("Produksi Harian");

            const selectedItem = inventory.find(i => i.id == selectedItemId);

            // Filter inventory based on search
            const filteredOptions = inventory
                .filter(i => i.name.toLowerCase().includes(filterText.toLowerCase()))
                .sort((a,b) => a.name.localeCompare(b.name));

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedItemId) return showToast("Pilih barang dari daftar yang tersedia", 'error');
                handleRecordUsage(selectedItemId, amount, reason);
                setAmount("");
                setReason("Produksi Harian");
                setFilterText(""); 
                setSelectedItemId("");
                setIsOpen(false);
            };

            return (
                <div className="max-w-4xl mx-auto space-y-8">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="clipboard-minus" className="text-emerald-600"></i>
                                Pencatatan Pemakaian Bahan
                            </h2>
                            <p className="text-gray-500 text-sm mt-1">Input manual untuk bahan rusak, tumpah, atau sampling</p>
                        </div>
                        <Button variant="secondary" onClick={() => setView('list')}>
                            <Icon name="arrow-left" size={16} /> Kembali ke Stok
                        </Button>
                    </div>

                    <Card>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Pilih Bahan</label>
                                    <div className="relative">
                                        <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                                        <input 
                                            type="text" 
                                            placeholder="Cari atau pilih bahan..." 
                                            className={`w-full pl-9 pr-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none ${!selectedItemId && filterText ? 'border-amber-300 bg-amber-50' : 'border-gray-300'}`}
                                            value={filterText}
                                            onChange={e => { 
                                                setFilterText(e.target.value); 
                                                setSelectedItemId(""); 
                                                setIsOpen(true);
                                            }}
                                            onFocus={() => setIsOpen(true)}
                                            onBlur={() => setTimeout(() => setIsOpen(false), 200)}
                                        />
                                        
                                        {/* Autocomplete Dropdown */}
                                        {isOpen && !selectedItemId && (
                                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                                                {filteredOptions.length > 0 ? (
                                                    filteredOptions.map(item => (
                                                        <div 
                                                            key={item.id}
                                                            className="px-4 py-2.5 hover:bg-emerald-50 cursor-pointer border-b border-gray-50 last:border-0 group transition-colors"
                                                            onClick={() => {
                                                                setSelectedItemId(item.id);
                                                                setFilterText(item.name);
                                                                setIsOpen(false);
                                                            }}
                                                        >
                                                            <div className="flex justify-between items-center">
                                                                <span className="font-medium text-gray-800 group-hover:text-emerald-700">{item.name}</span>
                                                                <span className={`text-xs px-2 py-0.5 rounded-full ${item.stock <= item.minStock ? 'bg-rose-100 text-rose-600' : 'bg-gray-100 text-gray-500'}`}>
                                                                    Sisa: {item.stock} {item.unit}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="p-3 text-sm text-gray-400 text-center italic">Bahan tidak ditemukan</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    {!selectedItemId && filterText && (
                                        <p className="text-xs text-amber-600 mt-1 animate-pulse">* Silakan klik opsi di list untuk memilih</p>
                                    )}
                                </div>
                                
                                {selectedItem && (
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-center gap-4 animate-in fade-in slide-in-from-top-2">
                                        <div className="bg-white p-2 rounded-full shadow-sm">
                                            <i data-lucide="package" className="text-blue-500"></i>
                                        </div>
                                        <div>
                                            <div className="text-sm text-gray-500">Stok Tersedia</div>
                                            <div className="text-lg font-bold text-gray-800">{selectedItem.stock} {selectedItem.unit}</div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Jumlah Terpakai</label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="number" step="0.1" min="0" placeholder="0.0"
                                            className="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                                            value={amount} onChange={e => setAmount(e.target.value)} required
                                        />
                                        <div className="bg-gray-100 px-4 py-2.5 rounded-lg text-gray-500 font-medium border border-gray-200">
                                            {selectedItem ? selectedItem.unit : '-'}
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Keterangan / Alasan</label>
                                    <select 
                                        className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                                        value={reason} onChange={e => setReason(e.target.value)}
                                    >
                                        <option>Produksi Harian</option>
                                        <option>Bahan Rusak / Basi</option>
                                        <option>Spilled / Tumpah</option>
                                        <option>Sampling / Tester</option>
                                        <option>Lainnya</option>
                                    </select>
                                </div>
                                <Button type="submit" className="w-full justify-center mt-2" disabled={!selectedItem}>
                                    <i data-lucide="check-circle" className="w-4 h-4"></i> Konfirmasi Pengurangan
                                </Button>
                            </div>
                        </form>
                    </Card>

                    {/* History Table */}
                    <div className="space-y-4">
                        <h3 className="font-bold text-gray-700">Riwayat Penggunaan Terakhir</h3>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                            <table className="w-full text-left text-sm whitespace-nowrap">
                                <thead className="bg-gray-50 text-gray-600">
                                    <tr>
                                        <th className="p-3">Waktu</th>
                                        <th className="p-3">Nama Bahan</th>
                                        <th className="p-3">Jumlah</th>
                                        <th className="p-3">Keterangan</th>
                                        <th className="p-3 text-right">Est. Biaya</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {usageLog.slice(0, 10).map(log => (
                                        <tr key={log.id} className="hover:bg-gray-50">
                                            <td className="p-3 text-gray-500">{formatDate(log.date)}</td>
                                            <td className="p-3 font-medium">{log.itemName}</td>
                                            <td className="p-3 font-bold text-rose-600">-{log.amount} {log.unit}</td>
                                            <td className="p-3 text-gray-600"><Badge>{log.reason}</Badge></td>
                                            <td className="p-3 text-right text-gray-500">{formatRupiah(log.cost)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

                const ProductView = ({ products, setProducts, inventory, showToast, canEdit, calculateHPP, handleProduce }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempProduct, setTempProduct] = useState(null);
            const [productionQty, setProductionQty] = useState({}); // { productId: qty }

            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [isEditing, tempProduct, productionQty]);

            const startEdit = (product) => {
                setTempProduct(JSON.parse(JSON.stringify(product || {
                    id: "", name: "", overhead: 0, sellingPrice: 0, recipe: []
                })));
                setIsEditing(true);
            };

            const saveProduct = () => {
                if (!tempProduct.name) return showToast("Nama produk wajib diisi", 'error');
                if (tempProduct.recipe.length === 0) return showToast("Minimal harus ada 1 bahan baku", 'error');
                
                const newProd = { ...tempProduct, id: tempProduct.id || generateId() };
                
                if (tempProduct.id) {
                    setProducts(products.map(p => p.id === newProd.id ? newProd : p));
                } else {
                    setProducts([...products, newProd]);
                }
                setIsEditing(false);
                showToast("Resep berhasil disimpan!", 'success');
            };

            const deleteProduct = (id) => {
                if (confirm("Hapus produk ini?")) {
                    setProducts(products.filter(p => p.id !== id));
                }
            };

            const addIngredient = () => {
                setTempProduct({
                    ...tempProduct,
                    recipe: [...tempProduct.recipe, { itemId: inventory[0]?.id || "", qty: 1 }]
                });
            };

            const removeIngredient = (idx) => {
                const newRecipe = [...tempProduct.recipe];
                newRecipe.splice(idx, 1);
                setTempProduct({ ...tempProduct, recipe: newRecipe });
            };

            const updateIngredient = (idx, field, value) => {
                const newRecipe = [...tempProduct.recipe];
                newRecipe[idx] = { ...newRecipe[idx], [field]: value };
                setTempProduct({ ...tempProduct, recipe: newRecipe });
            };

            const calcTempHPP = () => {
                if (!tempProduct) return 0;
                return tempProduct.recipe.reduce((total, ing) => {
                    const item = inventory.find(i => i.id === ing.itemId);
                    return total + (item ? item.price * ing.qty : 0);
                }, 0) + (parseFloat(tempProduct.overhead) || 0);
            };

            if (isEditing) {
                return (
                    <Card className="max-w-3xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold">{tempProduct.id ? "Edit Resep Produk" : "Buat Resep Baru"}</h2>
                            <button onClick={() => setIsEditing(false)}><Icon name="x" size={24} /></button>
                        </div>
                        
                        <div className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium mb-1">Nama Produk / Menu</label>
                                <input type="text" className="w-full p-2 border rounded-lg" 
                                    value={tempProduct.name} onChange={e => setTempProduct({...tempProduct, name: e.target.value})} placeholder="Contoh: Kopi Susu" 
                                    readOnly={!canEdit} />
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-medium">Bahan Baku (Resep)</label>
                                    {canEdit && (
                                        <Button variant="secondary" onClick={addIngredient} className="text-xs py-1"><Icon name="plus" size={16} /> Tambah Bahan</Button>
                                    )}
                                </div>
                                <div className="space-y-2 bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    {tempProduct.recipe.length === 0 && <p className="text-center text-gray-400 text-sm">Belum ada bahan baku dipilih</p>}
                                    {tempProduct.recipe.map((ing, idx) => {
                                        const item = inventory.find(i => i.id === ing.itemId);
                                        const subtotal = item ? item.price * ing.qty : 0;
                                        return (
                                            <div key={idx} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row md:items-center gap-3 transition-all hover:border-emerald-200">
                                                {/* Selection Area */}
                                                <div className="flex-1">
                                                    <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 md:hidden">Pilih Bahan</label>
                                                    <select 
                                                        className="w-full p-2.5 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" 
                                                        value={ing.itemId} 
                                                        onChange={e => updateIngredient(idx, 'itemId', e.target.value)}
                                                        disabled={!canEdit}
                                                    >
                                                        {inventory.map(item => (
                                                            <option key={item.id} value={item.id}>{item.name} (@ {formatRupiah(item.price)}/{item.unit})</option>
                                                        ))}
                                                    </select>
                                                </div>

                                                {/* Qty & Price Area */}
                                                <div className="flex items-center justify-between md:justify-end gap-3 w-full md:w-auto">
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-24">
                                                            <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 md:hidden">Jumlah</label>
                                                            <input 
                                                                type="number" step="any" min="0" 
                                                                className="w-full p-2.5 border border-gray-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-emerald-500 outline-none font-medium"
                                                                value={ing.qty} 
                                                                onChange={e => updateIngredient(idx, 'qty', parseFloat(e.target.value))} 
                                                                placeholder="0"
                                                                readOnly={!canEdit} 
                                                            />
                                                        </div>
                                                        <span className="text-sm text-gray-500 font-medium pt-4 md:pt-0 w-8">
                                                            {item?.unit || '-'}
                                                        </span>
                                                    </div>

                                                    <div className="flex items-center gap-3 border-l md:border-l-0 pl-3 md:pl-0 border-gray-100">
                                                        <div className="text-right min-w-[80px]">
                                                            <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 md:hidden">Subtotal</label>
                                                            <div className="font-bold text-gray-700 text-sm">{formatRupiah(subtotal)}</div>
                                                        </div>
                                                        
                                                        {canEdit && (
                                                            <button 
                                                                onClick={() => removeIngredient(idx)} 
                                                                className="text-rose-500 hover:text-rose-700 hover:bg-rose-50 p-2 rounded-lg transition-colors mt-4 md:mt-0" 
                                                                title="Hapus Bahan"
                                                            >
                                                                <Icon name="trash-2" size={18} />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Harga Jual (IDR)</label>
                                    <input type="number" className="w-full p-2 border rounded-lg" 
                                        value={tempProduct.sellingPrice} onChange={e => setTempProduct({...tempProduct, sellingPrice: parseFloat(e.target.value)})} placeholder="0" 
                                        readOnly={!canEdit} />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Biaya Lain/Overhead (IDR)</label>
                                    <input type="number" className="w-full p-2 border rounded-lg" 
                                        value={tempProduct.overhead} onChange={e => setTempProduct({...tempProduct, overhead: parseFloat(e.target.value)})} placeholder="0" 
                                        readOnly={!canEdit} />
                                    <p className="text-xs text-gray-400 mt-1">Biaya packaging, listrik, dll per porsi.</p>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-6 pt-4 border-t border-gray-100">
                                <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                    <div className="text-sm text-emerald-800 mb-1">Total HPP per Porsi</div>
                                    <div className="text-2xl font-bold text-emerald-600">{formatRupiah(calcTempHPP())}</div>
                                </div>
                                <div className={`p-4 rounded-xl border ${ (tempProduct.sellingPrice - calcTempHPP()) > 0 ? 'bg-blue-50 border-blue-100' : 'bg-rose-50 border-rose-100'}`}>
                                    <div className="text-sm text-gray-800 mb-1">Margin Profit</div>
                                    <div className={`text-2xl font-bold ${ (tempProduct.sellingPrice - calcTempHPP()) > 0 ? 'text-blue-600' : 'text-rose-600'}`}>
                                        {formatRupiah(tempProduct.sellingPrice - calcTempHPP())}
                                    </div>
                                </div>
                            </div>

                            {canEdit && (
                                <div className="flex gap-3 pt-4 border-t">
                                    <Button onClick={saveProduct} className="flex-1 justify-center">Simpan Resep</Button>
                                    <Button variant="secondary" onClick={() => setIsEditing(false)}>Batal</Button>
                                </div>
                            )}
                        </div>
                    </Card>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Daftar Menu Resep</h2>
                        {canEdit && (
                            <Button onClick={() => startEdit(null)}><Icon name="plus" size={20} /> Buat Menu Baru</Button>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {products.map(product => {
                            const hpp = calculateHPP(product);
                            const maxStock = Math.min(...product.recipe.map(ing => {
                                const item = inventory.find(i => i.id === ing.itemId);
                                return item ? Math.floor(item.stock / ing.qty) : 0;
                            }));
                            
                            return (
                                <Card key={product.id} className="relative flex flex-col">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 className="font-bold text-lg text-gray-900">{product.name}</h3>
                                            <div className="text-sm text-gray-500">{product.recipe.length} Bahan Baku</div>
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={() => startEdit(product)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded"><Icon name={canEdit ? "edit-2" : "eye"} size={16} /></button>
                                            {canEdit && (
                                                <button onClick={() => deleteProduct(product.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded"><Icon name="trash-2" size={16} /></button>
                                            )}
                                        </div>
                                    </div>

                                    <div className="space-y-3 flex-1">
                                        <div className="flex justify-between items-center py-2 border-y border-gray-100">
                                            <div className="text-center flex-1 border-r border-gray-100">
                                                <div className="text-[10px] text-gray-500 uppercase">HPP</div>
                                                <div className="font-bold text-gray-700">{formatRupiah(hpp)}</div>
                                            </div>
                                            <div className="text-center flex-1">
                                                <div className="text-[10px] text-gray-500 uppercase">Margin</div>
                                                <div className={`font-bold ${ (product.sellingPrice - hpp) > 0 ? 'text-blue-600' : 'text-rose-600'}`}>
                                                    {product.sellingPrice > 0 ? ((product.sellingPrice - hpp) / product.sellingPrice * 100).toFixed(0) : 0}%
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex items-center justify-between gap-2 text-sm bg-gray-50 p-2 rounded-lg">
                                            <div className="flex-1">
                                                <div className="text-[10px] text-gray-500 uppercase font-bold mb-1">Jual / Produksi</div>
                                                <div className="flex gap-1">
                                                    <input 
                                                        type="number" min="1" 
                                                        className="w-full p-1 text-center border border-gray-300 rounded text-sm focus:ring-2 focus:ring-emerald-500 outline-none" 
                                                        placeholder="Qty"
                                                        value={productionQty[product.id] || ''}
                                                        onChange={e => setProductionQty({...productionQty, [product.id]: parseInt(e.target.value)})}
                                                    />
                                                    <button 
                                                        onClick={() => handleProduce(product, productionQty[product.id] || 0)} 
                                                        className="bg-emerald-500 hover:bg-emerald-600 text-white p-1.5 rounded transition-colors"
                                                        title="Catat Produksi & Kurangi Stok"
                                                    >
                                                        <Icon name="check" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="text-right border-l border-gray-200 pl-2">
                                                <div className="text-[10px] text-gray-500 uppercase font-bold mb-1">Est. Stok</div>
                                                <div className={`font-bold text-lg ${maxStock < 5 ? 'text-rose-600' : 'text-emerald-600'}`}>
                                                    {maxStock}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="text-xs text-gray-500 mt-2">
                                            <div className="font-semibold mb-1">Bahan Utama:</div>
                                            <ul className="list-disc pl-4 space-y-0.5">
                                                {product.recipe.slice(0, 3).map((r, i) => {
                                                    const item = inventory.find(x => x.id === r.itemId);
                                                    return <li key={i}>{item?.name} ({r.qty} {item?.unit})</li>
                                                })}
                                                {product.recipe.length > 3 && <li>...dan {product.recipe.length - 3} lainnya</li>}
                                            </ul>
                                        </div>
                                    </div>
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

                const RestockView = ({ inventory, products, user, showToast, requests, setRequests, setInventory, restockCart, setRestockCart, formatRupiah, formatDate, handleSendRestock }) => {
            const [activeTab, setActiveTab] = useState('new'); // 'new' or 'list'
            const [editingRequestId, setEditingRequestId] = useState(null);
            const [filterMenuId, setFilterMenuId] = useState("all");
            const [selectedRestockItems, setSelectedRestockItems] = useState(new Set()); // Track checkboxes

            // Initialize cart with low stock items if empty
            useEffect(() => {
                if (activeTab === 'new' && Object.keys(restockCart).length === 0 && !editingRequestId) {
                    const lowStock = {};
                    const newSelected = new Set();
                    let hasNew = false;
                    inventory.forEach(item => {
                        if (item.stock <= item.minStock) {
                            lowStock[item.id] = item.minStock * 2; // Suggest ordering double min stock
                            newSelected.add(item.id);
                            hasNew = true;
                        }
                    });
                    if (hasNew) {
                        setRestockCart(prev => ({ ...prev, ...lowStock }));
                        setSelectedRestockItems(newSelected);
                    }
                }
            }, [activeTab, editingRequestId]);

            const filteredInventory = useMemo(() => {
                if (filterMenuId === "all") return inventory;
                const targetProduct = products.find(p => p.id === filterMenuId);
                if (!targetProduct) return inventory;
                
                const ingredientIds = new Set(targetProduct.recipe.map(r => r.itemId));
                return inventory.filter(i => ingredientIds.has(i.id));
            }, [inventory, products, filterMenuId]);

            // Toggle Selection (Checklist) only
            const toggleItem = (itemId) => {
                setSelectedRestockItems(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(itemId)) newSet.delete(itemId);
                    else newSet.add(itemId);
                    return newSet;
                });
            };

            const updateCart = (id, value) => {
                const val = parseFloat(value);
                setRestockCart(prev => ({ ...prev, [id]: val }));
                
                // Auto-select if value is typed and greater than 0
                if (val > 0) {
                    setSelectedRestockItems(prev => {
                            const newSet = new Set(prev);
                            newSet.add(id);
                            return newSet;
                    });
                }
            };

            const totalEstimation = inventory.reduce((acc, item) => {
                if (!selectedRestockItems.has(item.id)) return acc;
                const qty = parseFloat(restockCart[item.id]) || 0;
                return acc + (qty * item.price);
            }, 0);

            const itemsInCart = inventory.filter(i => selectedRestockItems.has(i.id) && parseFloat(restockCart[i.id]) > 0).length;

            const handleSaveRequest = () => {
                const itemsToOrder = inventory.filter(i => selectedRestockItems.has(i.id) && parseFloat(restockCart[i.id]) > 0).map(item => ({
                    id: item.id,
                    name: item.name,
                    unit: item.unit,
                    price: item.price,
                    qty: parseFloat(restockCart[item.id]),
                    isRealized: false 
                }));

                if (itemsToOrder.length === 0) return showToast("Pilih minimal 1 barang (Checklist & Qty > 0)", 'error');

                if (editingRequestId) {
                    // Update Existing
                    setRequests(requests.map(req => req.id === editingRequestId ? {
                        ...req,
                        items: itemsToOrder,
                        totalEst: totalEstimation,
                        requester: `${req.requester} (Edited by ${user.name})`
                    } : req));
                    setEditingRequestId(null);
                    showToast("Request berhasil diperbarui!", 'success');
                } else {
                    // Create New
                    const newRequest = {
                        id: `REQ-${Date.now().toString().slice(-6)}`,
                        date: new Date().toISOString(),
                        requester: user.name,
                        items: itemsToOrder,
                        totalEst: totalEstimation,
                        status: 'pending',
                        realizedBy: null,
                        realizedAt: null
                    };
                    setRequests([newRequest, ...requests]);
                    showToast("Request berhasil disimpan!", 'success');
                }

                setRestockCart({});
                setSelectedRestockItems(new Set());
                setActiveTab('list');
            };

            const handleEditRequest = (req) => {
                const cart = {};
                const selected = new Set();
                req.items.forEach(item => {
                    cart[item.id] = item.qty;
                    selected.add(item.id);
                });
                setRestockCart(cart);
                setSelectedRestockItems(selected);
                setEditingRequestId(req.id);
                setActiveTab('new');
            };

            const handleDeleteRequest = (id) => {
                if (confirm("Hapus request ini secara permanen?")) {
                    setRequests(requests.filter(req => req.id !== id));
                    showToast("Request berhasil dihapus!", 'success');
                }
            };

            const handleDeleteRequestItem = (reqId, itemId) => {
                if (confirm("Hapus item ini dari request?")) {
                    setRequests(requests.map(req => {
                        if (req.id === reqId) {
                            return {
                                ...req,
                                items: req.items.filter(item => item.id !== itemId)
                            };
                        }
                        return req;
                    }));
                    showToast("Item berhasil dihapus!", 'success');
                }
            };

            const handleUpdateItem = (reqId, itemId, field, value) => {
                const val = parseFloat(value);
                if (val < 0) return;

                setRequests(requests.map(req => {
                    if (req.id === reqId) {
                        const updatedItems = req.items.map(item => 
                            item.id === itemId ? { ...item, [field]: isNaN(val) ? 0 : val } : item
                        );
                        const newTotal = updatedItems.reduce((acc, curr) => acc + (curr.qty * (curr.price || 0)), 0);
                        return { ...req, items: updatedItems, totalEst: newTotal };
                    }
                    return req;
                }));
            };

            const toggleItemRealization = (reqId, itemId) => {
                if (user.role !== 'ceo') return showToast("Hanya CEO yang bisa memvalidasi realisasi.", 'error');

                let stockAdjustment = 0;
                let targetItemId = null;

                const updatedRequests = requests.map(req => {
                    if (req.id === reqId) {
                        const updatedItems = req.items.map(item => {
                            if (item.id === itemId) {
                                // Determine stock action: Add if checking, Subtract if unchecking
                                stockAdjustment = !item.isRealized ? item.qty : -item.qty;
                                targetItemId = item.id;
                                return { ...item, isRealized: !item.isRealized };
                            }
                            return item;
                        });

                        const allRealized = updatedItems.every(item => item.isRealized);
                        
                        return {
                            ...req,
                            items: updatedItems,
                            status: allRealized ? 'done' : 'pending',
                            realizedBy: allRealized ? user.name : (req.status === 'done' ? null : req.realizedBy),
                            realizedAt: allRealized ? new Date().toISOString() : null
                        };
                    }
                    return req;
                });

                setRequests(updatedRequests);

                // Update Inventory Stock Automatically
                if (targetItemId) {
                    setInventory(prevInventory => prevInventory.map(invItem => {
                        if (invItem.id === targetItemId) {
                            return { ...invItem, stock: invItem.stock + stockAdjustment };
                        }
                        return invItem;
                    }));
                }
            };

            return (
                <div className="h-[calc(100vh-100px)] flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Pengadaan Stok</h2>
                            <p className="text-gray-500 text-sm">Susun daftar belanja untuk supplier</p>
                        </div>
                        <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => { setActiveTab('new'); setEditingRequestId(null); setRestockCart({}); }} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'new' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                {editingRequestId ? 'Mode Edit' : 'Buat Baru'}
                            </button>
                            <button onClick={() => setActiveTab('list')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'list' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                Daftar Request
                                {requests.filter(r => r.status === 'pending').length > 0 && (
                                    <span className="bg-rose-500 text-white text-[10px] px-1.5 rounded-full">{requests.filter(r => r.status === 'pending').length}</span>
                                )}
                            </button>
                        </div>
                    </div>

                    {activeTab === 'new' ? (
                        <>
                            <div className="flex flex-col md:flex-row items-start md:items-center gap-4 bg-white p-3 pr-4 rounded-xl border border-gray-200 shadow-sm mb-4 justify-between sticky top-0 z-20">
                                <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 w-full md:w-auto">
                                    <div className="flex justify-between items-center w-full md:w-auto">
                                        <div className="px-3 py-2 bg-emerald-50 rounded-lg text-emerald-700 font-bold border border-emerald-100 text-sm whitespace-nowrap">
                                            Total: {formatRupiah(totalEstimation)}
                                        </div>
                                        {/* Mobile Save Button (Visible only on small screens) */}
                                        <div className="md:hidden flex gap-2">
                                            <Button size="sm" onClick={handleSaveRequest} disabled={itemsInCart === 0} className="px-3 py-2 text-xs">
                                                <Icon name="save" size={16} /> Simpan
                                            </Button>
                                        </div>
                                    </div>
                                    <select 
                                        className="w-full md:w-48 p-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm text-sm"
                                        value={filterMenuId} onChange={e => setFilterMenuId(e.target.value)}
                                    >
                                        <option value="all">Semua Bahan</option>
                                        {products.map(p => (
                                            <option key={p.id} value={p.id}>{p.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="hidden md:flex gap-2">
                                    <Button variant="outline" onClick={handleSendRestock} disabled={itemsInCart === 0}>
                                        <Icon name="share-2" size={18} /> Share WA
                                    </Button>
                                    <Button onClick={handleSaveRequest} disabled={itemsInCart === 0}>
                                        <Icon name="save" size={18} /> {editingRequestId ? 'Update Request' : 'Simpan Request'}
                                    </Button>
                                </div>
                            </div>

                            <div className="flex-1 overflow-auto bg-gray-50 md:bg-white rounded-xl shadow-none md:shadow-sm md:border border-gray-200">
                                {/* Desktop Table */}
                                <table className="hidden md:table w-full text-left text-sm sticky top-0">
                                    <thead className="bg-gray-100 text-gray-700 font-bold z-10 sticky top-0 shadow-sm">
                                        <tr>
                                            <th className="p-4 w-12 text-center">
                                                <Icon name="check-square" size={18} />
                                            </th>
                                            <th className="p-4 w-1/3">Nama Bahan</th>
                                            <th className="p-4 whitespace-nowrap">Stok Saat Ini</th>
                                            <th className="p-4">Status</th>
                                            <th className="p-4 w-32">Qty Order</th>
                                            <th className="p-4 text-right">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredInventory.map(item => (
                                            <tr key={item.id} className={restockCart[item.id] !== undefined ? "bg-emerald-50/30" : "hover:bg-gray-50"}>
                                                <td className="p-4 text-center">
                                                    <input 
                                                        type="checkbox" 
                                                        className="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                                                        checked={selectedRestockItems.has(item.id)}
                                                        onChange={() => toggleItem(item.id)}
                                                    />
                                                </td>
                                                <td className="p-4">
                                                    <div className="font-medium">{item.name}</div>
                                                    <div className="text-xs text-gray-500">Harga: {formatRupiah(item.price)}/{item.unit}</div>
                                                </td>
                                                <td className="p-4">
                                                    <div className="whitespace-nowrap">
                                                        <span className="font-bold text-gray-800">{parseFloat(item.stock).toLocaleString('id-ID', { maximumFractionDigits: 3 })}</span>
                                                        <span className="ml-1 text-xs text-gray-500">{item.unit}</span>
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    {item.stock <= item.minStock && <Badge type="danger">Perlu Restock</Badge>}
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex items-center">
                                                        <input 
                                                            type="number" min="0" step="any"
                                                            className={`w-24 p-2 text-center border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none ${selectedRestockItems.has(item.id) ? 'border-emerald-500 font-bold bg-white' : 'border-gray-200 bg-gray-50'}`}
                                                            placeholder="0"
                                                            value={restockCart[item.id] || ''}
                                                            onChange={e => updateCart(item.id, e.target.value)}
                                                        />
                                                        <span className="ml-2 text-gray-500 text-xs">{item.unit}</span>
                                                    </div>
                                                </td>
                                                <td className="p-4 text-right font-medium text-gray-700">
                                                    {formatRupiah((parseFloat(restockCart[item.id]) || 0) * item.price)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>

                                {/* Mobile Card List */}
                                <div className="md:hidden space-y-3 pb-20">
                                    {filteredInventory.map(item => {
                                        const qty = parseFloat(restockCart[item.id]);
                                        const isActive = selectedRestockItems.has(item.id);
                                        return (
                                            <div key={item.id} className={`bg-white p-4 rounded-xl border ${isActive ? 'border-emerald-500 shadow-emerald-100 shadow-md' : 'border-gray-200'}`}>
                                                <div className="flex gap-3 mb-3">
                                                    <div className="pt-1">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                                                            checked={isActive}
                                                            onChange={() => toggleItem(item.id)}
                                                        />
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex justify-between items-start">
                                                            <div>
                                                                <div className="font-bold text-gray-900">{item.name}</div>
                                                                <div className="text-xs text-gray-500">{formatRupiah(item.price)} / {item.unit}</div>
                                                            </div>
                                                            {item.stock <= item.minStock && <Badge type="danger">Low</Badge>}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex items-center justify-between gap-4 pl-8">
                                                    <div className="text-xs text-gray-500 flex flex-col sm:flex-row sm:items-center gap-1">
                                                        <span>Stok:</span> 
                                                        <span className="font-bold text-gray-800 whitespace-nowrap">
                                                            {parseFloat(item.stock).toLocaleString('id-ID', { maximumFractionDigits: 3 })} {item.unit}
                                                        </span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <input 
                                                            type="number" min="0" step="any"
                                                            className={`w-20 p-2 text-center border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm ${isActive ? 'border-emerald-500 font-bold text-emerald-700 bg-emerald-50' : 'border-gray-200'}`}
                                                            placeholder="0"
                                                            value={restockCart[item.id] || ''}
                                                            onChange={e => updateCart(item.id, e.target.value)}
                                                        />
                                                        <span className="text-xs text-gray-400">{item.unit}</span>
                                                    </div>
                                                </div>
                                                {isActive && (
                                                    <div className="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center pl-8">
                                                        <span className="text-xs text-emerald-600 font-medium">Subtotal</span>
                                                        <span className="text-sm font-bold text-emerald-700">{formatRupiah(qty * item.price)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </>
                    ) : (
                        <div className="flex-1 overflow-auto space-y-4">
                            {requests.length === 0 && (
                                <div className="text-center py-12 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                                    <Icon name="inbox" size={48} className="mx-auto mb-4 opacity-20" />
                                    <p>Belum ada request restock.</p>
                                </div>
                            )}
                            {requests.map(req => (
                                <Card key={req.id} className={`transition-all ${req.status === 'done' ? 'opacity-60 bg-gray-50' : 'border-l-4 border-l-emerald-500'}`}>
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <div className="flex items-center gap-3">
                                                <h3 className="font-bold text-lg text-gray-800">{req.id}</h3>
                                                <Badge type={req.status === 'done' ? 'success' : 'warning'}>
                                                    {req.status === 'done' ? 'Terealisasi' : 'Menunggu Realisasi'}
                                                </Badge>
                                            </div>
                                            <div className="text-xs text-gray-500 mt-1">
                                                Dibuat oleh <b>{req.requester}</b> pada {formatDate(req.date)}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold text-lg text-emerald-600">{formatRupiah(req.totalEst)}</div>
                                            <div className="flex gap-2 justify-end mt-1">
                                                {/* Show Edit Button if no items are realized yet */}
                                                {!req.items.some(i => i.isRealized) && (
                                                    <button onClick={() => handleEditRequest(req)} className="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded">
                                                        <Icon name="edit-3" size={12} /> Edit
                                                    </button>
                                                )}
                                                {(user.role === 'owner' || user.role === 'ceo') && (
                                                    <button onClick={() => handleDeleteRequest(req.id)} className="text-xs flex items-center gap-1 text-rose-600 hover:text-rose-800 bg-rose-50 px-2 py-1 rounded">
                                                        <Icon name="trash-2" size={12} /> Hapus
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-gray-50 rounded-lg p-3 mb-4">
                                        <ul className="text-sm space-y-2">
                                            {req.items.map((item, idx) => (
                                                <li key={idx} className="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                                                    <div className="flex items-center gap-2">
                                                        {user.role === 'ceo' ? (
                                                            <input 
                                                                type="checkbox" 
                                                                checked={item.isRealized || false} 
                                                                onChange={() => toggleItemRealization(req.id, item.id)}
                                                                className="w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                                                            />
                                                        ) : (
                                                            item.isRealized && <Icon name="check-circle" size={14} className="text-emerald-500" />
                                                        )}
                                                        <span className={item.isRealized ? "text-gray-400 line-through" : "text-gray-700"}>{item.name}</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex items-center text-xs text-gray-500 bg-gray-50 rounded px-2 py-1" title="Harga Satuan">
                                                            <span className="mr-1">Rp</span>
                                                            <input 
                                                                type="number" 
                                                                className="w-20 bg-transparent text-right outline-none border-b border-gray-300 focus:border-emerald-500"
                                                                value={item.price}
                                                                onChange={(e) => handleUpdateItem(req.id, item.id, 'price', e.target.value)}
                                                                disabled={user.role === 'staff' && item.isRealized}
                                                            />
                                                        </div>
                                                        <div className="flex items-center text-xs text-gray-500 bg-gray-50 rounded px-2 py-1" title="Volume/Qty">
                                                            <input 
                                                                type="number" step="any"
                                                                className="w-12 bg-transparent text-center outline-none border-b border-gray-300 focus:border-emerald-500 font-medium text-gray-700"
                                                                value={item.qty}
                                                                onChange={(e) => handleUpdateItem(req.id, item.id, 'qty', e.target.value)}
                                                                disabled={user.role === 'staff' && item.isRealized}
                                                            />
                                                            <span className="ml-1 text-gray-400">{item.unit}</span>
                                                        </div>
                                                        {(user.role === 'owner' || user.role === 'ceo') && !item.isRealized && (
                                                            <button onClick={() => handleDeleteRequestItem(req.id, item.id)} className="text-rose-400 hover:text-rose-600 p-1 rounded hover:bg-rose-50" title="Hapus Item">
                                                                <Icon name="trash-2" size={14} />
                                                            </button>
                                                        )}
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>

                                    <div className="flex justify-between items-center pt-2 border-t border-gray-100">
                                        <div className="text-xs text-gray-500">
                                            {req.status === 'done' ? (
                                                <span className="flex items-center gap-1 text-emerald-600 font-medium">
                                                    <Icon name="check-circle" size={14} /> Selesai direalisasi {req.realizedBy ? `oleh ${req.realizedBy}` : ''}
                                                </span>
                                            ) : (
                                                <span className="text-amber-600">Proses Realisasi ({req.items.filter(i => i.isRealized).length}/{req.items.length} item)</span>
                                            )}
                                        </div>
                                        {user.role !== 'ceo' && req.status !== 'done' && (
                                            <span className="text-xs text-gray-400 italic">Menunggu konfirmasi CEO</span>
                                        )}
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

                const HPPCalculator = ({ inventory, products, formatRupiah, calculateHPP }) => {
            const [targetQty, setTargetQty] = useState(1);
            const [components, setComponents] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desiredMargin, setDesiredMargin] = useState(30);
            const [sellingPrice, setSellingPrice] = useState(0);

            // Persist State
            useEffect(() => {
                const saved = localStorage.getItem('hpp_calc_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setTargetQty(parsed.targetQty || 1);
                    setComponents(parsed.components || []);
                    setExtras(parsed.extras || []);
                    setDesiredMargin(parsed.desiredMargin || 30);
                    setSellingPrice(parsed.sellingPrice || 0);
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('hpp_calc_state', JSON.stringify({
                    targetQty, components, extras, desiredMargin, sellingPrice
                }));
            }, [targetQty, components, extras, desiredMargin, sellingPrice]);

            const addComponent = () => {
                setComponents([...components, { id: Date.now(), itemId: inventory[0]?.id || "", qty: 1, unit: inventory[0]?.unit || 'unit', price: inventory[0]?.price || 0 }]);
            };

            const updateComponent = (idx, field, value) => {
                const newComps = [...components];
                if (field === 'itemId') {
                    const item = inventory.find(i => i.id === value);
                    newComps[idx] = { ...newComps[idx], itemId: value, unit: item?.unit || '-', price: item?.price || 0 };
                } else {
                    newComps[idx][field] = value;
                }
                setComponents(newComps);
            };

            const removeComponent = (idx) => {
                setComponents(components.filter((_, i) => i !== idx));
            };

            const addExtra = () => {
                setExtras([...extras, { id: Date.now(), name: "Biaya Lain (Gas/Listrik)", cost: 0 }]);
            };

            const updateExtra = (idx, field, value) => {
                const newExtras = [...extras];
                newExtras[idx][field] = value;
                setExtras(newExtras);
            };

            const removeExtra = (idx) => {
                setExtras(extras.filter((_, i) => i !== idx));
            };

            // Calculations
            const totalMaterialCost = components.reduce((sum, c) => sum + (c.price * c.qty), 0);
            const totalExtraCost = extras.reduce((sum, e) => sum + e.cost, 0);
            const grandTotal = totalMaterialCost + totalExtraCost;
            const hppPerUnit = targetQty > 0 ? grandTotal / targetQty : 0;
            
            // Simulation Logic
            const suggestedPrice = hppPerUnit > 0 ? hppPerUnit / (1 - (desiredMargin / 100)) : 0;
            const actualMargin = sellingPrice > 0 ? ((sellingPrice - hppPerUnit) / sellingPrice) * 100 : 0;
            const profitPerUnit = sellingPrice - hppPerUnit;

            return (
                <div className="space-y-6 max-w-5xl mx-auto pb-20">
                    <div className="flex justify-between items-start">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Kalkulator HPP & Profit</h2>
                            <p className="text-gray-500 text-sm">Hitung modal produksi per batch atau satuan</p>
                        </div>
                        <div className="bg-indigo-50 px-4 py-2 rounded-xl border border-indigo-100 flex items-center gap-3">
                            <span className="text-indigo-800 text-sm font-bold">Target Produksi (Qty):</span>
                            <input 
                                type="number" min="1" 
                                className="w-20 p-1 text-center font-bold text-lg border border-indigo-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
                                value={targetQty}
                                onChange={e => setTargetQty(parseFloat(e.target.value) || 1)}
                            />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        {/* LEFT COLUMN: INPUTS */}
                        <div className="lg:col-span-7 space-y-6">
                            {/* Material Costs */}
                            <Card className="border-emerald-100 bg-emerald-50/30">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-emerald-900 flex items-center gap-2">
                                        <Icon name="package" size={18} className="text-emerald-600" /> Biaya Bahan Baku
                                    </h3>
                                    <Button size="sm" onClick={addComponent} variant="outline" className="text-xs bg-white hover:bg-emerald-50 text-emerald-700 border-emerald-200">
                                        <Icon name="plus" size={14} /> Tambah
                                    </Button>
                                </div>
                                <div className="space-y-3">
                                    {components.length === 0 && <p className="text-center text-emerald-400/60 text-sm py-4 italic">Belum ada bahan dipilih</p>}
                                    {components.map((comp, idx) => (
                                        <div key={comp.id} className="bg-white p-3 rounded-xl border border-emerald-100 shadow-sm flex flex-col sm:flex-row gap-2 sm:items-center transition-all hover:border-emerald-300">
                                            <div className="flex-1 flex gap-2 w-full sm:w-auto">
                                                <select 
                                                    className="flex-1 p-2 text-sm border border-emerald-100 rounded-lg bg-emerald-50/50 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                    value={comp.itemId}
                                                    onChange={e => updateComponent(idx, 'itemId', e.target.value)}
                                                >
                                                    {inventory.map(i => (
                                                        <option key={i.id} value={i.id}>{i.name} (@ {formatRupiah(i.price)}/{i.unit})</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="flex justify-between items-center gap-3 w-full sm:w-auto">
                                                <div className="flex items-center gap-2">
                                                    <input 
                                                        type="number" step="any" min="0"
                                                        className="w-20 p-2 text-center text-sm border border-emerald-100 rounded-lg bg-emerald-50/50 focus:ring-2 focus:ring-emerald-500 outline-none font-medium"
                                                        value={comp.qty}
                                                        onChange={e => updateComponent(idx, 'qty', parseFloat(e.target.value))}
                                                    />
                                                    <span className="text-xs text-emerald-600 font-bold w-8">{comp.unit}</span>
                                                </div>
                                                <div className="flex items-center gap-3 min-w-[100px] justify-end">
                                                    <span className="font-bold text-emerald-800 text-sm">{formatRupiah(comp.price * comp.qty)}</span>
                                                    <button onClick={() => removeComponent(idx)} className="text-rose-400 hover:text-rose-600 p-1.5 hover:bg-rose-50 rounded-lg transition-colors">
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-3 border-t border-emerald-200 flex justify-between items-center">
                                    <span className="text-sm font-bold text-emerald-700 uppercase tracking-wide">Subtotal Bahan</span>
                                    <span className="font-bold text-emerald-700 text-lg">{formatRupiah(totalMaterialCost)}</span>
                                </div>
                            </Card>

                            {/* Overhead Costs */}
                            <Card className="border-amber-100 bg-amber-50/30">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-amber-900 flex items-center gap-2">
                                        <Icon name="zap" size={18} className="text-amber-600" /> Biaya Operasional
                                    </h3>
                                    <Button size="sm" onClick={addExtra} variant="outline" className="text-xs bg-white hover:bg-amber-50 text-amber-700 border-amber-200">
                                        <Icon name="plus" size={14} /> Tambah
                                    </Button>
                                </div>
                                <div className="space-y-3">
                                    {extras.length === 0 && <p className="text-center text-amber-400/60 text-sm py-4 italic">Belum ada biaya tambahan</p>}
                                    {extras.map((extra, idx) => (
                                        <div key={extra.id} className="bg-white p-3 rounded-xl border border-amber-100 shadow-sm flex items-center gap-3 transition-all hover:border-amber-300">
                                            <input 
                                                type="text" 
                                                className="flex-1 p-2 text-sm border border-amber-100 rounded-lg bg-amber-50/50 focus:ring-2 focus:ring-amber-500 outline-none"
                                                value={extra.name}
                                                onChange={e => updateExtra(idx, 'name', e.target.value)}
                                                placeholder="Nama Biaya"
                                            />
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-amber-600 font-bold">Rp</span>
                                                <input 
                                                    type="number" min="0"
                                                    className="w-24 p-2 text-right text-sm border border-amber-100 rounded-lg bg-amber-50/50 focus:ring-2 focus:ring-amber-500 outline-none font-bold text-amber-800"
                                                    value={extra.cost}
                                                    onChange={e => updateExtra(idx, 'cost', parseFloat(e.target.value))}
                                                />
                                            </div>
                                            <button onClick={() => removeExtra(idx)} className="text-rose-400 hover:text-rose-600 p-1.5 hover:bg-rose-50 rounded-lg transition-colors">
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-3 border-t border-amber-200 flex justify-between items-center">
                                    <span className="text-sm font-bold text-amber-700 uppercase tracking-wide">Subtotal Ops</span>
                                    <span className="font-bold text-amber-700 text-lg">{formatRupiah(totalExtraCost)}</span>
                                </div>
                            </Card>
                        </div>

                        {/* RIGHT COLUMN: RESULTS */}
                        <div className="lg:col-span-5 space-y-6">
                            <div className="bg-slate-800 text-white p-6 rounded-2xl shadow-xl shadow-slate-200 sticky top-6">
                                <h3 className="text-slate-400 text-sm uppercase font-bold tracking-widest mb-6 border-b border-slate-700 pb-4">Hasil Perhitungan</h3>
                                
                                <div className="space-y-6">
                                    <div>
                                        <div className="text-slate-400 text-xs mb-1">Total Modal (HPP Total)</div>
                                        <div className="text-3xl font-bold text-emerald-400">{formatRupiah(grandTotal)}</div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-6">
                                        <div>
                                            <div className="text-slate-400 text-xs mb-1">HPP per Unit</div>
                                            <div className="text-xl font-bold">{formatRupiah(hppPerUnit)}</div>
                                        </div>
                                        <div>
                                            <div className="text-slate-400 text-xs mb-1">Break Even Point</div>
                                            <div className="text-xl font-bold text-amber-400">{Math.ceil(grandTotal / (sellingPrice || 1))} unit</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-8 pt-6 border-t border-slate-700 space-y-6">
                                    {/* Scenario A: Set Margin -> Get Price */}
                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="text-xs font-bold text-blue-400 uppercase">Skenario A: Target Margin</div>
                                            <div className="bg-slate-700 px-2 py-1 rounded text-xs font-bold">{desiredMargin}%</div>
                                        </div>
                                        <input 
                                            type="range" min="0" max="100" step="5"
                                            className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 mb-2"
                                            value={desiredMargin}
                                            onChange={e => setDesiredMargin(parseInt(e.target.value))}
                                        />
                                        <div className="flex justify-between items-center bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                                            <span className="text-xs text-slate-300">Saran Harga Jual:</span>
                                            <span className="font-bold text-blue-400">{formatRupiah(suggestedPrice)}</span>
                                        </div>
                                    </div>

                                    {/* Scenario B: Set Price -> Get Profit */}
                                    <div>
                                        <div className="text-xs font-bold text-emerald-400 uppercase mb-2">Skenario B: Target Harga</div>
                                        <div className="relative mb-3">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold">Rp</span>
                                            <input 
                                                type="number" 
                                                className="w-full pl-8 pr-3 py-2 bg-slate-700 border border-slate-600 rounded-lg font-bold text-white outline-none focus:border-emerald-500 transition-colors"
                                                placeholder="Masukan Harga Jual..."
                                                value={sellingPrice || ''}
                                                onChange={e => setSellingPrice(parseFloat(e.target.value))}
                                            />
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className={`p-3 rounded-lg border text-center ${actualMargin > 0 ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400' : 'bg-rose-500/20 border-rose-500/50 text-rose-400'}`}>
                                                <div className="text-[10px] font-bold uppercase mb-1">Net Profit</div>
                                                <div className="font-bold">{formatRupiah(profitPerUnit)}</div>
                                            </div>
                                            <div className={`p-3 rounded-lg border text-center ${actualMargin > 0 ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400' : 'bg-rose-500/20 border-rose-500/50 text-rose-400'}`}>
                                                <div className="text-[10px] font-bold uppercase mb-1">Margin</div>
                                                <div className="font-bold">{actualMargin.toFixed(1)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

                const FinanceView = ({ usageLog, requests, inventory, products, user, formatRupiah, formatDate }) => {
            // Default to current month start - today
            const [startDate, setStartDate] = useState(() => {
                const date = new Date();
                return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().slice(0, 10);
            });
            const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
            
            const [operationalCost, setOperationalCost] = useState(0); 

            // Filter logs based on date range
            const filteredLogs = useMemo(() => {
                return usageLog.filter(log => {
                    const logDate = log.date.slice(0, 10);
                    return logDate >= startDate && logDate <= endDate;
                });
            }, [usageLog, startDate, endDate]);

            // Financial Calculations
            const financeStats = useMemo(() => {
                let revenue = 0;
                let cogs = 0; // HPP
                let waste = 0; // Spilled/Expired

                filteredLogs.forEach(log => {
                    if (log.reason && log.reason.toLowerCase().includes("produksi")) {
                        let itemRevenue = log.revenue;
                        if (itemRevenue === undefined || itemRevenue === null) {
                            const prod = products.find(p => p.id === log.itemId);
                            itemRevenue = prod ? (prod.sellingPrice || 0) * log.amount : 0;
                        }
                        revenue += itemRevenue;
                        cogs += log.cost;
                    } else {
                        waste += log.cost;
                    }
                });

                const grossProfit = revenue - cogs;
                const netProfit = grossProfit - waste - operationalCost;

                return { revenue, cogs, waste, grossProfit, netProfit };
            }, [filteredLogs, operationalCost, products]);

            // Helper for Period Display
            const getPeriodString = () => {
                const start = new Date(startDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                const end = new Date(endDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                return `${start} - ${end}`;
            };

            // Export Functions
            const handleExportCSV = () => {
                const escapeCsv = (str) => `"${String(str).replace(/"/g, '""')}"`;

                const rows = [
                    ["RINGKASAN LABA RUGI"],
                    [`Periode: ${getPeriodString()}`],
                    [""],
                    ["KETERANGAN", "NILAI (IDR)"],
                    ["Pendapatan (Revenue)", financeStats.revenue],
                    ["Harga Pokok Penjualan (COGS)", -financeStats.cogs],
                    ["LABA KOTOR", financeStats.grossProfit],
                    [""],
                    ["Beban Waste/Rusak", -financeStats.waste],
                    ["Beban Operasional", -operationalCost],
                    ["TOTAL BEBAN", -(financeStats.waste + operationalCost)],
                    [""],
                    ["LABA BERSIH (NET PROFIT)", financeStats.netProfit]
                ];

                const csvContent = rows.map(e => e.map(escapeCsv).join(",")).join("\n");
                const link = document.createElement("a");
                link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
                link.download = `Ringkasan_Keuangan_${startDate}_to_${endDate}.csv`;
                link.click();
            };

            const handleDownloadRecap = () => {
                const escapeCsv = (str) => `"${String(str || '').replace(/"/g, '""')}"`;

                // 1. Sales Data
                const salesData = filteredLogs.filter(l => l.reason.toLowerCase().includes("produksi")).map(l => [
                    formatDate(l.date), l.itemName, l.amount, l.unit, l.cost, (l.revenue || 0)
                ]);

                // 2. Restock/Shopping Data (Realized Requests in this range)
                const realizedRequests = requests.filter(r => {
                    if (r.status !== 'done' || !r.realizedAt) return false;
                    const rDate = r.realizedAt.slice(0, 10);
                    return rDate >= startDate && rDate <= endDate;
                });
                
                const shoppingData = [];
                realizedRequests.forEach(req => {
                    req.items.forEach(item => {
                        shoppingData.push([
                            formatDate(req.realizedAt), req.id, item.name, item.qty, item.unit, item.price, (item.qty * item.price)
                        ]);
                    });
                });

                // 3. Waste Data
                const wasteData = filteredLogs.filter(l => !l.reason.toLowerCase().includes("produksi")).map(l => [
                    formatDate(l.date), l.itemName, l.amount, l.unit, l.reason, l.cost
                ]);

                let csvContent = `REKAPITULASI KEUANGAN DETAIL - ${getPeriodString().toUpperCase()}\n\n`;
                
                // Section 1: Summary
                csvContent += `I. RINGKASAN\nKeterangan,Nilai (IDR)\n`;
                csvContent += `Total Penjualan,${financeStats.revenue}\n`;
                csvContent += `Total HPP (Bahan Terpakai),${financeStats.cogs}\n`;
                csvContent += `Total Belanja (Restock),${shoppingData.reduce((sum, row) => sum + row[6], 0)}\n`;
                csvContent += `Total Waste,${financeStats.waste}\n`;
                csvContent += `Biaya Operasional,${operationalCost}\n`;
                csvContent += `Net Profit,${financeStats.netProfit}\n\n`;

                // Section 2: Sales
                csvContent += `II. DETAIL PENJUALAN (PRODUKSI)\nTanggal,Menu,Qty,Unit,HPP Total,Revenue\n`;
                csvContent += salesData.map(r => r.map(escapeCsv).join(",")).join("\n") + "\n\n";

                // Section 3: Shopping
                csvContent += `III. DETAIL BELANJA (RESTOCK)\nTanggal,No.Request,Item,Qty,Unit,Harga Satuan,Total\n`;
                csvContent += shoppingData.map(r => r.map(escapeCsv).join(",")).join("\n") + "\n\n";

                // Section 4: Waste
                csvContent += `IV. DETAIL WASTE & LAINNYA\nTanggal,Item,Qty,Unit,Alasan,Nilai Kerugian\n`;
                csvContent += wasteData.map(r => r.map(escapeCsv).join(",")).join("\n");

                const link = document.createElement("a");
                link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
                link.download = `Rekap_Lengkap_${startDate}_to_${endDate}.csv`;
                link.click();
            };

            const handlePrintReport = () => {
                const printWindow = window.open('', '', 'width=800,height=900');
                if(!printWindow) return showToast("Pop-up diblokir browser!", 'error');

                const htmlContent = `
                    <html>
                    <head>
                        <title>Laporan Keuangan - ${getPeriodString()}</title>
                        <style>
                            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; color: #1e293b; line-height: 1.5; }
                            .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
                            .header h1 { margin: 0; font-size: 24px; text-transform: uppercase; color: #0f172a; }
                            .header p { margin: 5px 0 0; color: #64748b; font-size: 14px; }
                            .section-title { font-size: 14px; font-weight: bold; color: #475569; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
                            .row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
                            .row:not(:last-child) { border-bottom: 1px dashed #e2e8f0; }
                            .row.highlight { font-weight: 600; background-color: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 5px; }
                            .row.total { font-size: 18px; font-weight: 700; background-color: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #cbd5e1; }
                            .value { font-family: 'Courier New', monospace; font-weight: 600; }
                            .text-red { color: #ef4444; }
                            .text-green { color: #10b981; }
                            .signatures { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; }
                            .sig-box { text-align: center; width: 200px; }
                            .sig-line { border-top: 1px solid #94a3b8; margin-top: 60px; font-weight: 600; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Laporan Laba Rugi</h1>
                            <p>Periode: ${getPeriodString()}</p>
                            <p>Dicetak: ${new Date().toLocaleDateString('id-ID')} oleh ${user.name}</p>
                        </div>

                        <div class="section-title">Pendapatan</div>
                        <div class="row">
                            <span>Penjualan Bersih (Revenue)</span>
                            <span class="value">${formatRupiah(financeStats.revenue)}</span>
                        </div>
                        <div class="row">
                            <span>Harga Pokok Penjualan (HPP)</span>
                            <span class="value text-red">(${formatRupiah(financeStats.cogs)})</span>
                        </div>
                        <div class="row highlight">
                            <span>LABA KOTOR</span>
                            <span class="value">${formatRupiah(financeStats.grossProfit)}</span>
                        </div>

                        <div style="margin-top: 20px;"></div>
                        <div class="section-title">Beban Operasional</div>
                        <div class="row">
                            <span>Waste / Bahan Rusak</span>
                            <span class="value text-red">(${formatRupiah(financeStats.waste)})</span>
                        </div>
                        <div class="row">
                            <span>Biaya Operasional (Total Periode)</span>
                            <span class="value text-red">(${formatRupiah(operationalCost)})</span>
                        </div>
                        
                        <div class="row total">
                            <span>LABA BERSIH (NET PROFIT)</span>
                            <span class="value ${financeStats.netProfit >= 0 ? 'text-green' : 'text-red'}">
                                ${formatRupiah(financeStats.netProfit)}
                            </span>
                        </div>

                        <div class="signatures">
                            <div class="sig-box">
                                Dibuat Oleh
                                <div class="sig-line">${user.name}</div>
                            </div>
                            <div class="sig-box">
                                Disetujui Oleh
                                <div class="sig-line">Owner / Manager</div>
                            </div>
                        </div>
                        <script>window.onload = function() { window.print(); };<\/script>
                    </body>
                    </html>
                `;
                printWindow.document.write(htmlContent);
                printWindow.document.close();
            };

            return (
                <div className="space-y-8 animate-in fade-in duration-500">
                    {/* Header & Controls */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 tracking-tight">Laporan Keuangan</h2>
                            <p className="text-slate-500 mt-1">Pantau performa bisnis dan arus kas.</p>
                        </div>
                        
                        <div className="flex flex-wrap items-end gap-4 w-full md:w-auto bg-slate-50 p-3 rounded-xl border border-slate-200">
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Periode Tanggal</label>
                                <div className="flex items-center gap-2">
                                    <input 
                                        type="date" 
                                        className="px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                                        value={startDate}
                                        onChange={e => setStartDate(e.target.value)}
                                    />
                                    <span className="text-slate-400 font-bold">-</span>
                                    <input 
                                        type="date" 
                                        className="px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                                        value={endDate}
                                        onChange={e => setEndDate(e.target.value)}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Biaya Ops (Total Periode)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">Rp</span>
                                    <input 
                                        type="number" 
                                        className="pl-8 pr-3 py-2 w-32 bg-white border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                                        placeholder="0"
                                        value={operationalCost || ''}
                                        onChange={e => setOperationalCost(parseFloat(e.target.value) || 0)}
                                    />
                                </div>
                            </div>
                            <div className="flex gap-2 ml-auto md:ml-0">
                                <div className="relative group">
                                    <Button variant="secondary" className="h-[38px]">
                                        <Icon name="download" size={16} /> Laporan
                                    </Button>
                                    <div className="absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 p-2 hidden group-hover:block z-20 animate-in slide-in-from-top-2">
                                        <button onClick={handleExportCSV} className="w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm flex items-center gap-2 text-slate-600">
                                            <Icon name="file-text" size={14} /> Ringkasan (CSV)
                                        </button>
                                        <button onClick={handleDownloadRecap} className="w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm flex items-center gap-2 text-slate-600">
                                            <Icon name="table" size={14} /> Rekap Lengkap (CSV)
                                        </button>
                                        <div className="h-px bg-slate-100 my-1"></div>
                                        <button onClick={handlePrintReport} className="w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm flex items-center gap-2 text-slate-600">
                                            <Icon name="printer" size={14} /> Print PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                        {[
                            { title: "Pendapatan", value: financeStats.revenue, icon: "wallet", color: "emerald", sub: "Total omzet kotor" },
                            { title: "HPP & Modal", value: financeStats.cogs, icon: "shopping-bag", color: "blue", sub: "Biaya bahan baku" },
                            { title: "Beban & Waste", value: financeStats.waste + operationalCost, icon: "trending-down", color: "rose", sub: `Waste: ${formatRupiah(financeStats.waste)}` },
                            { title: "Laba Bersih", value: financeStats.netProfit, icon: "pie-chart", color: financeStats.netProfit >= 0 ? "indigo" : "amber", sub: "Net Profit" }
                        ].map((stat, i) => (
                            <div key={i} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden group hover:shadow-md transition-all">
                                <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-${stat.color}-600`}>
                                    <Icon name={stat.icon} size={64} />
                                </div>
                                <div className="relative z-10">
                                    <div className={`inline-flex p-2.5 rounded-xl bg-${stat.color}-50 text-${stat.color}-600 mb-4`}>
                                        <Icon name={stat.icon} size={20} />
                                    </div>
                                    <div className="text-slate-500 text-sm font-semibold">{stat.title}</div>
                                    <div className={`text-2xl font-bold mt-1 mb-1 text-slate-800`}>
                                        {formatRupiah(stat.value)}
                                    </div>
                                    <div className="text-xs text-slate-400 font-medium">{stat.sub}</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Analytics Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <Card className="lg:col-span-2 flex flex-col">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="bar-chart-2" className="text-blue-600" size={20} />
                                    Analisis Arus Kas
                                </h3>
                                <Badge>{getPeriodString()}</Badge>
                            </div>
                            <div className="flex-1 min-h-[300px]">
                                <ChartComponent 
                                    type="bar" 
                                    data={{
                                        labels: ['Pendapatan', 'HPP (Modal)', 'Beban (Ops+Waste)', 'Laba Bersih'],
                                        datasets: [{
                                            label: 'Total (IDR)',
                                            data: [financeStats.revenue, financeStats.cogs, financeStats.waste + operationalCost, financeStats.netProfit],
                                            backgroundColor: [
                                                'rgba(16, 185, 129, 0.8)', // Emerald
                                                'rgba(59, 130, 246, 0.8)', // Blue
                                                'rgba(244, 63, 94, 0.8)',  // Rose
                                                'rgba(99, 102, 241, 0.8)'  // Indigo
                                            ],
                                            borderRadius: 6,
                                            barThickness: 40
                                        }]
                                    }}
                                    options={{ 
                                        plugins: { legend: { display: false } },
                                        scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } } }
                                    }}
                                />
                            </div>
                        </Card>

                        <div className="space-y-6">
                            <Card>
                                <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <Icon name="activity" className="text-amber-500" size={20} />
                                    Indikator Performa
                                </h3>
                                <div className="space-y-4">
                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-500">Gross Margin</span>
                                            <span className="font-bold text-emerald-600">
                                                {financeStats.revenue > 0 ? ((financeStats.grossProfit / financeStats.revenue) * 100).toFixed(1) : 0}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 rounded-full h-2">
                                            <div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${financeStats.revenue > 0 ? Math.min(((financeStats.grossProfit / financeStats.revenue) * 100), 100) : 0}%` }}></div>
                                        </div>
                                    </div>

                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                        <div className="flex justify-between text-sm mb-1">
                                            <span className="text-slate-500">Net Profit Margin</span>
                                            <span className="font-bold text-indigo-600">
                                                {financeStats.revenue > 0 ? ((financeStats.netProfit / financeStats.revenue) * 100).toFixed(1) : 0}%
                                            </span>
                                        </div>
                                        <div className="w-full bg-slate-200 rounded-full h-2">
                                            <div className="bg-indigo-500 h-2 rounded-full" style={{ width: `${financeStats.revenue > 0 ? Math.min(((financeStats.netProfit / financeStats.revenue) * 100), 100) : 0}%` }}></div>
                                        </div>
                                    </div>

                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 text-center">
                                        <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Break Even Point (Ops)</div>
                                        <div className="text-lg font-bold text-slate-700">{formatRupiah(operationalCost)}</div>
                                        <div className="text-[10px] text-slate-400 mt-1">Target minimal laba kotor</div>
                                    </div>
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        function KitchenPro() {
            const { showToast } = useToast();

            // User Auth State
            const [user, setUser] = useState(() => {
                const saved = localStorage.getItem('fnb_user_role');
                return saved ? JSON.parse(saved) : null;
            });

            // State
            const [inventory, setInventory] = useState(() => {
                const saved = localStorage.getItem('fnb_inventory_data');
                return saved ? JSON.parse(saved) : initialData;
            });
            const [products, setProducts] = useState(() => {
                const saved = localStorage.getItem('fnb_products_data');
                return saved ? JSON.parse(saved) : initialProducts;
            });
            const [usageLog, setUsageLog] = useState(() => {
                const saved = localStorage.getItem('fnb_usage_log');
                return saved ? JSON.parse(saved) : [];
            });
            const [requests, setRequests] = useState(() => {
                const saved = localStorage.getItem('fnb_requests_data');
                return saved ? JSON.parse(saved) : [];
            });
            const [restockCart, setRestockCart] = useState({}); // { itemId: qty }

            // Hash Routing logic for view
            const [view, setView] = useState(() => {
                const hash = window.location.hash.replace('#', '');
                return hash || 'dashboard';
            });

            // Effect to sync URL hash
            useEffect(() => {
                window.location.hash = view;
            }, [view]);

            // Effect to listen to back button
            useEffect(() => {
                const onHashChange = () => {
                    const hash = window.location.hash.replace('#', '');
                    if (hash && hash !== view) {
                        setView(hash);
                    }
                };
                window.addEventListener('hashchange', onHashChange);
                return () => window.removeEventListener('hashchange', onHashChange);
            }, [view]);

            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 768);
            const [showFormModal, setShowFormModal] = useState(false);

            // Effects
            useEffect(() => {
                const handleResize = () => {
                    if (window.innerWidth >= 768) {
                        // Desktop: Keep current state or ensure at least collapsed
                        // No strict enforcement to avoid annoyance, but could set true if needed
                    } else {
                        // Mobile: Auto close if resized down
                        if (isSidebarOpen) setIsSidebarOpen(false);
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                if (user) localStorage.setItem('fnb_user_role', JSON.stringify(user));
                else localStorage.removeItem('fnb_user_role');
                
                localStorage.setItem('fnb_inventory_data', JSON.stringify(inventory));
                localStorage.setItem('fnb_usage_log', JSON.stringify(usageLog));
                localStorage.setItem('fnb_products_data', JSON.stringify(products));
                localStorage.setItem('fnb_requests_data', JSON.stringify(requests));
            }, [inventory, usageLog, products, requests, user]);

            useEffect(() => {
                if (user) lucide.createIcons();
            }); // Run on every render

            // --- Auth Logic ---
            const handleLogin = (role, features = ['list', 'products', 'usage', 'restock', 'finance']) => {
                setUser({ 
                    role, 
                    name: role === 'owner' ? 'Owner' : 'CEO',
                    features: ['dashboard', 'settings', ...features] // Always include dashboard & settings
                });
                setView('dashboard');
            };

            const handleLogout = () => {
                setUser(null);
                setRestockCart({});
            };

            // RBAC Helpers
            const canEdit = user?.role === 'owner';

            // Stats
            const stats = useMemo(() => {
                const totalItems = inventory.length;
                const lowStockItems = inventory.filter(item => item.stock <= item.minStock).length;
                const totalValue = inventory.reduce((acc, item) => acc + (item.stock * item.price), 0);
                
                // Monthly usage stats (mock logic for demo)
                const usageThisMonth = usageLog.length;

                return { totalItems, lowStockItems, totalValue, usageThisMonth };
            }, [inventory, usageLog]);

            // --- Core Logic ---

            const handleSaveItem = (item) => {
                if (item.id) {
                    setInventory(inventory.map(i => i.id === item.id ? item : i));
                } else {
                    setInventory([...inventory, { ...item, id: generateId() }]);
                }
                setShowFormModal(false);
                setEditingItem(null);
            };

            const handleDelete = (id) => {
                if (confirm('Hapus item ini dari database?')) {
                    setInventory(inventory.filter(item => item.id !== id));
                }
            };

            const handleRecordUsage = (itemId, amount, reason) => {
                const item = inventory.find(i => i.id == itemId);
                if (!item) return;

                const qty = parseFloat(amount);
                if (qty <= 0) return showToast("Jumlah harus lebih dari 0", 'error');
                if (item.stock < qty) return showToast(`Stok tidak cukup! Sisa: ${item.stock} ${item.unit}`, 'error');

                // Deduct stock
                setInventory(inventory.map(i => i.id == itemId ? { ...i, stock: i.stock - qty } : i));

                // Log transaction
                const log = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    itemId: item.id,
                    itemName: item.name,
                    amount: qty,
                    unit: item.unit,
                    reason: reason, // e.g., "Produksi", "Spilled", "Expired"
                    cost: qty * item.price
                };
                setUsageLog([log, ...usageLog]);
                showToast("Pemakaian berhasil dicatat!", 'success');
            };

            const handleSendRestock = () => {
                const itemsToOrder = inventory.filter(i => restockCart[i.id] && parseFloat(restockCart[i.id]) > 0);
                if (itemsToOrder.length === 0) return showToast("Belum ada item yang di-request.", 'error');

                let message = `*REQUEST RESTOCK BAHAN BAKU*\n`;
                message += `Tanggal: ${new Date().toLocaleDateString('id-ID')}\n`;
                message += `--------------------------------\n`;
                
                let grandTotal = 0;

                itemsToOrder.forEach(item => {
                    const qty = parseFloat(restockCart[item.id]);
                    const subtotal = qty * item.price;
                    grandTotal += subtotal;
                    message += `- ${item.name}: ${qty} ${item.unit} (Est: ${formatRupiah(subtotal)})\n`;
                });

                message += `--------------------------------\n`;
                message += `*Est. Total Biaya: ${formatRupiah(grandTotal)}*`;

                // Try to open WhatsApp or Copy to Clipboard
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                
                if (confirm("Buka WhatsApp untuk mengirim request ini?")) {
                    window.open(whatsappUrl, '_blank');
                } else {
                    navigator.clipboard.writeText(message);
                    showToast("Request disalin ke clipboard!", 'success');
                }
                
                // Optional: Clear cart or save order history
                // setRestockCart({});
            };

            const handleProduce = (product, qty) => {
                if (qty <= 0) return showToast("Jumlah produksi harus lebih dari 0", 'error');

                // Check stock availability
                const missingItems = [];
                product.recipe.forEach(ing => {
                    const item = inventory.find(i => i.id === ing.itemId);
                    if (!item || item.stock < (ing.qty * qty)) {
                        missingItems.push(item ? item.name : "Item tidak ditemukan");
                    }
                });

                if (missingItems.length > 0) {
                    return showToast(`Stok bahan kurang: ${missingItems[0]}`, 'error');
                }

                if (!confirm(`Konfirmasi produksi ${qty} ${product.name}?\nStok bahan baku akan dikurangi otomatis.`)) return;

                // Deduct stock
                const newInventory = inventory.map(item => {
                    const ingredient = product.recipe.find(r => r.itemId === item.id);
                    if (ingredient) {
                        return { ...item, stock: item.stock - (ingredient.qty * qty) };
                    }
                    return item;
                });

                setInventory(newInventory);

                const hpp = calculateHPP(product);
                const revenue = (product.sellingPrice || 0) * qty;

                // Log usage (grouped)
                const log = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    itemId: product.id, // Using product ID for reference
                    itemName: `[Produksi] ${product.name}`,
                    amount: qty,
                    unit: "porsi",
                    reason: "Produksi / Penjualan",
                    cost: hpp * qty,
                    revenue: revenue // Added Revenue Tracking
                };
                setUsageLog([log, ...usageLog]);
                showToast("Produksi dicatat! Stok dikurangi.", 'success');
            };

            const calculateHPP = (product) => {
                const ingredientsCost = product.recipe.reduce((total, ing) => {
                    const item = inventory.find(i => i.id === ing.itemId);
                    return total + (item ? item.price * ing.qty : 0);
                }, 0);
                return ingredientsCost + (parseFloat(product.overhead) || 0);
            };

            // --- System Features ---
            const handleExportData = () => {
                const data = {
                    version: "2.0",
                    timestamp: new Date().toISOString(),
                    inventory, products, usageLog, requests, user
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `KitchenPro_Backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm(`Restore data dari backup tanggal ${formatDate(data.timestamp)}? Data saat ini akan ditimpa.`)) {
                            if (data.inventory) setInventory(data.inventory);
                            if (data.products) setProducts(data.products);
                            if (data.usageLog) setUsageLog(data.usageLog);
                            if (data.requests) setRequests(data.requests);
                            showToast("Data berhasil dipulihkan!", 'success');
                            setView('dashboard');
                        }
                    } catch (err) {
                        showToast("File backup tidak valid!", 'error');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };

            const handleResetData = () => {
                if (prompt("KETIK 'RESET' UNTUK MENGHAPUS SEMUA DATA:") === 'RESET') {
                    setInventory(initialData);
                    setProducts(initialProducts);
                    setUsageLog([]);
                    setRequests([]);
                    showToast("Sistem di-reset ke pengaturan awal.", 'info');
                    setTimeout(() => window.location.reload(), 1000);
                }
            };

            // --- Views ---

            const Sidebar = () => {
                // Calculate pending requests count
                const pendingRequestsCount = requests.filter(r => r.status === 'pending').length;

                return (
                    <>
                        {/* Mobile Backdrop */}
                        {isSidebarOpen && (
                            <div 
                                className="fixed inset-0 bg-black/50 z-40 md:hidden fade-in duration-200"
                                onClick={() => setIsSidebarOpen(false)}
                            ></div>
                        )}

                        {/* Sidebar Container with Dynamic Theme */}
                        <div className={`fixed inset-y-0 left-0 text-white transition-all duration-300 z-50 flex flex-col no-print
                            ${user.role === 'owner' ? 'bg-slate-900' : 'bg-indigo-900'} 
                            ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} 
                            md:translate-x-0 
                            md:${isSidebarOpen ? 'w-64' : 'w-20'} w-64`}
                        >
                            <div className={`h-16 flex items-center px-6 border-b border-white/10 gap-3`}>
                                <div className={`${user.role === 'owner' ? 'bg-emerald-500' : 'bg-white/20'} p-1.5 rounded-lg flex-shrink-0`}>
                                    <Icon name="chef-hat" className="text-white" size={24} />
                                </div>
                                {/* Title */}
                                <div className={`flex flex-col transition-opacity duration-300 ${(!isSidebarOpen && window.innerWidth >= 768) ? 'opacity-0 w-0 overflow-hidden' : 'opacity-100'}`}>
                                    <span className="font-bold text-lg leading-tight">KitchenPro</span>
                                    <span className="text-[10px] text-white/50 uppercase tracking-wider">{user?.name} Mode</span>
                                </div>
                            </div>
                            
                            <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                                {[
                                    { id: 'dashboard', icon: 'layout-grid', label: 'Dashboard', access: 'all' },
                                    { id: 'list', icon: 'package', label: 'Stok Bahan', access: 'all' },
                                    { id: 'products', icon: 'coffee', label: 'Menu Resep', access: 'all' },
                                    { id: 'hpp', icon: 'calculator', label: 'Kalkulator HPP', access: 'all' }, // New
                                    { id: 'restock', icon: 'shopping-cart', label: 'Pengadaan Stok', access: 'all' },
                                    { id: 'finance', icon: 'banknote', label: 'Laporan Keuangan', access: 'owner' }, // New Menu
                                    { id: 'settings', icon: 'settings', label: 'Pengaturan', access: 'all' },
                                ].filter(m => {
                                    const roleMatch = m.access === 'all' || m.access === user.role;
                                    const featureMatch = user.features ? user.features.includes(m.id) : true;
                                    return roleMatch && featureMatch;
                                }).map(menu => (
                                    <button 
                                        key={menu.id} 
                                        onClick={() => { setView(menu.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                                        className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl transition-all group whitespace-nowrap relative
                                            ${view === menu.id || (menu.id === 'list' && view === 'usage') ? (user.role === 'owner' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' : 'bg-white text-indigo-900 shadow-lg') : 'text-white/60 hover:bg-white/10 hover:text-white'}`}
                                    >
                                        <div className="flex-shrink-0 relative">
                                            <Icon name={menu.icon} size={20} />
                                            {menu.id === 'restock' && pendingRequestsCount > 0 && (
                                                <span className="absolute -top-1.5 -right-1.5 bg-rose-500 text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full border-2 border-slate-900">
                                                    {pendingRequestsCount > 9 ? '9+' : pendingRequestsCount}
                                                </span>
                                            )}
                                        </div>
                                        <span className={`font-medium transition-all duration-300 ${(!isSidebarOpen && window.innerWidth >= 768) ? 'opacity-0 w-0 overflow-hidden' : 'opacity-100'}`}>
                                            {menu.label}
                                        </span>
                                        
                                        {/* Tooltip */}
                                        {(!isSidebarOpen && window.innerWidth >= 768) && (
                                            <div className="absolute left-16 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50 pointer-events-none">
                                                {menu.label}
                                            </div>
                                        )}
                                    </button>
                                ))}
                            </nav>

                            <div className="p-4 border-t border-white/10 space-y-2">
                                <button onClick={handleLogout} className="w-full flex items-center gap-3 p-2 text-rose-300 hover:text-rose-200 hover:bg-rose-500/10 rounded-lg transition-colors group">
                                    <div className="flex-shrink-0"><Icon name="log-out" size={20} /></div>
                                    <span className={`transition-all duration-300 ${(!isSidebarOpen && window.innerWidth >= 768) ? 'opacity-0 w-0 overflow-hidden' : 'opacity-100'}`}>Logout</span>
                                </button>
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="w-full flex justify-center p-2 text-white/40 hover:text-white hidden md:flex">
                                    <Icon name={isSidebarOpen ? "chevrons-left" : "chevrons-right"} size={20} />
                                </button>
                            </div>
                        </div>
                    </>
                );
            };

            const Dashboard = () => {
                const [showValues, setShowValues] = useState(true);

                // --- Analytics Logic ---
                
                // 1. Usage Analysis (Highest & Lowest)
                const usageStats = useMemo(() => {
                    const map = {};
                    usageLog.forEach(log => {
                        map[log.itemName] = (map[log.itemName] || 0) + log.amount;
                    });
                    const sorted = Object.entries(map).sort((a, b) => b[1] - a[1]);
                    return {
                        labels: sorted.slice(0, 5).map(i => i[0]),
                        data: sorted.slice(0, 5).map(i => i[1]),
                        full: sorted
                    };
                }, [usageLog]);

                // 2. Price Analysis (Expensive vs Cheap)
                const priceStats = useMemo(() => {
                    const sorted = [...inventory].sort((a, b) => b.price - a.price);
                    return {
                        expensive: sorted.slice(0, 5),
                        cheapest: [...inventory].sort((a, b) => a.price - b.price).slice(0, 5)
                    };
                }, [inventory]);

                // 3. Turnover/Stock Out Analysis (Fast vs Slow Moving)
                // Logic: Usage / Stock Ratio. High ratio = Fast moving (Risk of stock out).
                const stockVelocity = useMemo(() => {
                    const velocity = inventory.map(item => {
                        const totalUsed = usageLog.filter(l => l.itemName === item.name).reduce((sum, l) => sum + l.amount, 0);
                        return { ...item, totalUsed };
                    });
                    
                    const fastMoving = [...velocity].sort((a, b) => b.totalUsed - a.totalUsed).slice(0, 5);
                    const slowMoving = [...velocity].filter(i => i.totalUsed === 0 || i.totalUsed < 5).slice(0, 5);
                    
                    return { fastMoving, slowMoving };
                }, [inventory, usageLog]);

                // 4. Product Production Analysis (Best Seller vs Least Popular)
                const productStats = useMemo(() => {
                    const prodMap = {};
                    usageLog.filter(l => l.itemId.startsWith('P')).forEach(log => {
                        prodMap[log.itemId] = (prodMap[log.itemId] || 0) + log.amount;
                    });

                    const prodArray = products.map(p => ({
                        ...p,
                        totalSold: prodMap[p.id] || 0
                    }));

                    const bestSellers = [...prodArray].sort((a, b) => b.totalSold - a.totalSold).slice(0, 5);
                    const leastPopular = [...prodArray].filter(p => p.totalSold === 0 || p.totalSold < 5).sort((a, b) => a.totalSold - b.totalSold).slice(0, 5);

                    return { 
                        labels: bestSellers.map(p => p.name),
                        data: bestSellers.map(p => p.totalSold),
                        leastPopular 
                    };
                }, [usageLog, products]);

                // 5. Product HPP Analysis (High vs Low Cost)
                const hppStats = useMemo(() => {
                    const withHpp = products.map(p => ({
                        ...p,
                        hpp: calculateHPP(p)
                    })).sort((a, b) => b.hpp - a.hpp);

                    return {
                        expensive: withHpp.slice(0, 5),
                        cheap: [...withHpp].reverse().slice(0, 5)
                    };
                }, [products, inventory]);

                return (
                    <div className="space-y-6 animate-in fade-in duration-500 pb-10">
                        {/* New Hero Section for Dashboard */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            {[
                                { title: "Total Aset", value: showValues ? formatRupiah(stats.totalValue) : "Rp •••••••", icon: "wallet", color: "emerald", desc: "Nilai stok saat ini" },
                                { title: "Item Stok", value: stats.totalItems, icon: "package", color: "blue", desc: "Total SKU aktif" },
                                { title: "Perlu Restock", value: stats.lowStockItems, icon: "alert-octagon", color: "rose", desc: "Stok di bawah batas" },
                                { title: "Aktivitas", value: stats.usageThisMonth, icon: "activity", color: "violet", desc: "Transaksi bulan ini" }
                            ].map((widget, i) => (
                                <div key={i} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-shadow flex items-start justify-between group relative">
                                    <div>
                                        <div className="flex items-center gap-2 mb-1">
                                            <div className="text-slate-500 text-sm font-medium">{widget.title}</div>
                                            {widget.title === "Total Aset" && (
                                                <button 
                                                    onClick={() => setShowValues(!showValues)} 
                                                    className="text-slate-400 hover:text-emerald-600 transition-colors"
                                                    title={showValues ? "Sembunyikan Nilai" : "Tampilkan Nilai"}
                                                >
                                                    <Icon name={showValues ? "eye" : "eye-off"} size={14} />
                                                </button>
                                            )}
                                        </div>
                                        <div className={`text-2xl font-bold text-slate-800 group-hover:text-${widget.color}-600 transition-colors`}>{widget.value}</div>
                                        <div className="text-xs text-slate-400 mt-1">{widget.desc}</div>
                                    </div>
                                    <div className={`p-3 rounded-xl bg-${widget.color}-50 text-${widget.color}-600`}>
                                        <Icon name={widget.icon} size={24} />
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Section: Stock & Menu Analysis */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card>
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Icon name="trending-up" size={20} className="text-emerald-600" />
                                    Analisa Pergerakan Stok
                                </h3>
                                <div className="grid grid-cols-2 gap-4 h-[250px]">
                                    <div className="bg-emerald-50 rounded-lg p-4 overflow-y-auto">
                                        <div className="text-xs font-bold text-emerald-700 uppercase mb-2">Fast Moving (Cepat Habis)</div>
                                        <ul className="text-sm space-y-2">
                                            {stockVelocity.fastMoving.map(item => (
                                                <li key={item.id} className="flex justify-between border-b border-emerald-100 pb-1">
                                                    <span className="truncate pr-2">{item.name}</span>
                                                    <span className="font-bold text-emerald-600">{item.totalUsed}</span>
                                                </li>
                                            ))}
                                            {stockVelocity.fastMoving.length === 0 && <li className="text-xs text-gray-400">Belum ada data</li>}
                                        </ul>
                                    </div>
                                    <div className="bg-slate-50 rounded-lg p-4 overflow-y-auto">
                                        <div className="text-xs font-bold text-slate-700 uppercase mb-2">Slow Moving (Jarang Pakai)</div>
                                        <ul className="text-sm space-y-2">
                                            {stockVelocity.slowMoving.slice(0, 5).map(item => (
                                                <li key={item.id} className="flex justify-between border-b border-slate-200 pb-1">
                                                    <span className="truncate pr-2">{item.name}</span>
                                                    <span className="text-slate-500">{item.totalUsed}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </Card>

                            <Card>
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Icon name="activity" size={20} className="text-orange-500" />
                                    Analisa Menu & HPP
                                </h3>
                                <div className="grid grid-cols-2 gap-4 h-[250px]">
                                    <div className="bg-orange-50 rounded-lg p-4 overflow-y-auto">
                                        <div className="text-xs font-bold text-orange-700 uppercase mb-2">HPP Tertinggi (Modal Mahal)</div>
                                        <ul className="text-sm space-y-2">
                                            {hppStats.expensive.map(p => (
                                                <li key={p.id} className="flex justify-between border-b border-orange-100 pb-1">
                                                    <span className="truncate pr-2">{p.name}</span>
                                                    <span className="font-bold text-orange-600">{formatRupiah(p.hpp)}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                    <div className="bg-blue-50 rounded-lg p-4 overflow-y-auto">
                                        <div className="text-xs font-bold text-blue-700 uppercase mb-2">HPP Terendah (Modal Murah)</div>
                                        <ul className="text-sm space-y-2">
                                            {hppStats.cheap.map(p => (
                                                <li key={p.id} className="flex justify-between border-b border-blue-100 pb-1">
                                                    <span className="truncate pr-2">{p.name}</span>
                                                    <span className="font-bold text-blue-600">{formatRupiah(p.hpp)}</span>
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                </div>
                            </Card>
                        </div>

                        {/* Section: Sales & Pricing */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card>
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Icon name="pie-chart" size={20} className="text-purple-600" />
                                    Menu Terlaris (Best Seller)
                                </h3>
                                {productStats.data.length > 0 ? (
                                    <ChartComponent 
                                        type="doughnut" 
                                        data={{
                                            labels: productStats.labels,
                                            datasets: [{
                                                label: 'Terjual',
                                                data: productStats.data,
                                                backgroundColor: [
                                                    'rgba(147, 51, 234, 0.6)',
                                                    'rgba(236, 72, 153, 0.6)',
                                                    'rgba(248, 113, 113, 0.6)',
                                                    'rgba(251, 146, 60, 0.6)',
                                                    'rgba(250, 204, 21, 0.6)'
                                                ],
                                                borderWidth: 1
                                            }]
                                        }}
                                        options={{ maintainAspectRatio: false }}
                                    />
                                ) : (
                                    <div className="h-[250px] flex items-center justify-center text-gray-400">Belum ada data penjualan</div>
                                )}
                            </Card>

                            <Card>
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <Icon name="dollar-sign" className="text-amber-500" size={20} />
                                    Analisa Harga Bahan
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <div className="text-xs font-semibold text-gray-500 mb-2">TERMAHAL (Top 3)</div>
                                        <div className="space-y-2">
                                            {priceStats.expensive.slice(0, 3).map((item, i) => (
                                                <div key={item.id} className="flex justify-between items-center bg-amber-50 p-2 rounded border border-amber-100">
                                                    <div className="flex items-center gap-2">
                                                        <span className="bg-amber-200 text-amber-800 w-5 h-5 flex items-center justify-center rounded-full text-xs font-bold">{i+1}</span>
                                                        <span className="text-sm font-medium">{item.name}</span>
                                                    </div>
                                                    <span className="text-sm font-bold text-amber-700">{formatRupiah(item.price)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-2 border-t border-gray-100">
                                        <div className="text-xs font-semibold text-gray-500 mb-2">TERMURAH (Top 3)</div>
                                        <div className="space-y-2">
                                            {priceStats.cheapest.slice(0, 3).map((item, i) => (
                                                <div key={item.id} className="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100">
                                                    <div className="flex items-center gap-2">
                                                        <span className="bg-gray-200 text-gray-600 w-5 h-5 flex items-center justify-center rounded-full text-xs font-bold">{i+1}</span>
                                                        <span className="text-sm font-medium">{item.name}</span>
                                                    </div>
                                                    <span className="text-sm font-bold text-gray-600">{formatRupiah(item.price)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        </div>

                        {/* Section: Stock Alerts */}
                        <div className="grid grid-cols-1">
                            <Card>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                        <Icon name="alert-triangle" className="text-rose-500" size={20} />
                                        Perlu Restock Segera
                                    </h3>
                                    <Button variant="secondary" onClick={() => setView('restock')} className="text-xs">
                                        Buat Order <Icon name="arrow-right" size={14} />
                                    </Button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-50 text-gray-500 font-medium">
                                            <tr>
                                                <th className="p-3 text-left pl-4">Bahan</th>
                                                <th className="p-3 text-center">Sisa Stok</th>
                                                <th className="p-3 text-center">Min. Stok</th>
                                                <th className="p-3 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {inventory.filter(i => i.stock <= i.minStock).map(item => (
                                                <tr key={item.id} className="hover:bg-gray-50">
                                                    <td className="p-3 pl-4 font-medium text-gray-900">{item.name}</td>
                                                    <td className="p-3 text-center font-bold text-rose-600">{item.stock} {item.unit}</td>
                                                    <td className="p-3 text-center text-gray-500">{item.minStock} {item.unit}</td>
                                                    <td className="p-3 text-center"><Badge type="danger">Kritis</Badge></td>
                                                </tr>
                                            ))}
                                            {inventory.filter(i => i.stock <= i.minStock).length === 0 && (
                                                <tr><td colSpan="4" className="p-6 text-center text-gray-400">Semua stok aman 🎉</td></tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            };

            const InventoryList_Deprecated = () => {
                const [filterMenuId, setFilterMenuId] = useState("all");
                const [opnameItem, setOpnameItem] = useState(null); // Item being adjusted
                const [opnameActual, setOpnameActual] = useState("");

                const handleOpnameSubmit = (e) => {
                    e.preventDefault();
                    if (!opnameItem) return;
                    
                    const actualStock = parseFloat(opnameActual);
                    if (isNaN(actualStock) || actualStock < 0) return showToast("Stok fisik tidak valid", 'error');

                    const systemStock = opnameItem.stock;
                    const variance = actualStock - systemStock;

                    if (variance === 0) {
                        showToast("Stok sudah sesuai (Tidak ada selisih)", 'info');
                        setOpnameItem(null);
                        return;
                    }

                    // 1. Adjust Stock
                    setInventory(inventory.map(i => i.id === opnameItem.id ? { ...i, stock: actualStock } : i));

                    // 2. Log Variance as Usage/Adjustment
                    const log = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        itemId: opnameItem.id,
                        itemName: opnameItem.name,
                        amount: Math.abs(variance),
                        unit: opnameItem.unit,
                        reason: variance < 0 ? "Stok Opname (Loss/Hilang)" : "Stok Opname (Surplus/Lebih)",
                        cost: Math.abs(variance) * opnameItem.price
                    };
                    setUsageLog([log, ...usageLog]);

                    showToast(`Stok Opname berhasil! Selisih: ${variance} ${opnameItem.unit}`, variance < 0 ? 'warning' : 'success');
                    setOpnameItem(null);
                    setOpnameActual("");
                };

                const filtered = useMemo(() => {
                    const term = searchTerm.toLowerCase();
                    const matchingProductIds = new Set();
                    
                    // Filter Logic:
                    // 1. If filterMenuId is set, ONLY show ingredients from that menu
                    // 2. If search term is present, search by name/category OR product name
                    
                    let filteredInventory = inventory;

                    if (filterMenuId !== "all") {
                        const targetProduct = products.find(p => p.id === filterMenuId);
                        if (targetProduct) {
                            const ingredientIds = new Set(targetProduct.recipe.map(r => r.itemId));
                            filteredInventory = filteredInventory.filter(i => ingredientIds.has(i.id));
                        }
                    }

                    if (term) {
                        products.forEach(p => {
                            if (p.name.toLowerCase().includes(term)) {
                                p.recipe.forEach(r => matchingProductIds.add(r.itemId));
                            }
                        });

                        filteredInventory = filteredInventory.filter(i => 
                            i.name.toLowerCase().includes(term) || 
                            i.category.toLowerCase().includes(term) ||
                            matchingProductIds.has(i.id)
                        );
                    }

                    return filteredInventory;
                }, [inventory, products, searchTerm, filterMenuId]);
                
                const [showColMenu, setShowColMenu] = useState(false);
                const [cols, setCols] = useState({
                    category: true,
                    price: true,
                    stock: true,
                    status: true,
                    usedIn: true,
                    action: true
                });

                const toggleCol = (key) => setCols({ ...cols, [key]: !cols[key] });

                return (
                    <div className="space-y-6">
                        {/* Print Header */}
                        <div className="hidden print-only mb-6 border-b pb-4">
                            <div className="flex justify-between items-end">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Laporan Stok Opname</h1>
                                    <p className="text-gray-500 mt-1">KitchenPro Inventory System</p>
                                </div>
                                <div className="text-right text-sm text-gray-600">
                                    <p>Tanggal: {new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    <p>User: {user?.name}</p>
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-col md:flex-row gap-4 items-center no-print">
                            {/* 1. Search */}
                            <div className="relative flex-1 w-full md:w-auto">
                                <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
                                <input 
                                    type="text" placeholder="Cari bahan, kategori, menu..." 
                                    className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-white shadow-sm"
                                    value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                                />
                            </div>

                            {/* 2. Menu Filter */}
                            <select 
                                className="w-full md:w-auto p-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm text-sm"
                                value={filterMenuId} onChange={e => setFilterMenuId(e.target.value)}
                            >
                                <option value="all">Semua Menu</option>
                                {products.map(p => (
                                    <option key={p.id} value={p.id}>{p.name}</option>
                                ))}
                            </select>

                            {/* 3. Button: Tambah Bahan */}
                            {canEdit && (
                                <Button onClick={() => { setEditingItem({}); setShowFormModal(true); }} className="w-full md:w-auto justify-center">
                                    <Icon name="plus" className="w-4 h-4" /> 
                                    <span className="hidden sm:inline">Tambah Bahan</span>
                                    <span className="sm:hidden">Tambah</span>
                                </Button>
                            )}

                            {/* 4. Button: Catat Pemakaian */}
                            <Button className="w-full md:w-auto justify-center bg-orange-500 hover:bg-orange-600 text-white shadow-orange-200" onClick={() => setView('usage')}>
                                <Icon name="clipboard-minus" className="w-4 h-4" /> 
                                <span className="hidden sm:inline">Catat Pemakaian</span>
                                <span className="sm:hidden">Pakai</span>
                            </Button>

                            {/* 5. Button: Print */}
                            <Button variant="secondary" onClick={() => window.print()} className="w-full md:w-auto justify-center px-3" title="Print Laporan">
                                <Icon name="printer" className="w-4 h-4" />
                                <span className="hidden lg:inline ml-2">Print</span>
                            </Button>

                            {/* 6. Button: Atur Kolom */}
                            <div className="relative w-full md:w-auto">
                                <Button variant="secondary" onClick={() => setShowColMenu(!showColMenu)} className="w-full justify-center px-3" title="Atur Kolom">
                                    <Icon name="columns" className="w-4 h-4" /> 
                                    <span className="hidden lg:inline ml-2">Kolom</span>
                                </Button>
                                {showColMenu && (
                                    <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 p-2 z-20 flex flex-col gap-1">
                                        <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" checked={cols.category} onChange={() => toggleCol('category')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                            <span className="text-sm">Kategori</span>
                                        </label>
                                        <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" checked={cols.price} onChange={() => toggleCol('price')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                            <span className="text-sm">Harga</span>
                                        </label>
                                        <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" checked={cols.stock} onChange={() => toggleCol('stock')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                            <span className="text-sm">Stok Fisik</span>
                                        </label>
                                        <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" checked={cols.status} onChange={() => toggleCol('status')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                            <span className="text-sm">Status</span>
                                        </label>
                                        <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" checked={cols.usedIn} onChange={() => toggleCol('usedIn')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                            <span className="text-sm">Menu</span>
                                        </label>
                                        <label className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                            <input type="checkbox" checked={cols.action} onChange={() => toggleCol('action')} className="rounded text-emerald-600 focus:ring-emerald-500" />
                                            <span className="text-sm">Aksi</span>
                                        </label>
                                    </div>
                                )}
                            </div>
                        </div>

                        {showColMenu && <div className="fixed inset-0 z-10" onClick={() => setShowColMenu(false)}></div>}

                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden card-print">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50/50 text-slate-600 border-b border-slate-100">
                                        <tr>
                                            <th className="p-4 font-semibold">Nama Bahan</th>
                                            {cols.category && <th className="p-4 font-semibold">Kategori</th>}
                                            {cols.price && <th className="p-4 font-semibold no-print">Harga/Unit</th>}
                                            {cols.stock && <th className="p-4 font-semibold text-center">Stok Fisik</th>}
                                            <th className="p-4 font-semibold text-center hidden print-only">Cek Fisik</th>
                                            {cols.status && <th className="p-4 font-semibold text-center no-print">Status</th>}
                                            {cols.usedIn && <th className="p-4 font-semibold no-print">Menu</th>}
                                            {cols.action && canEdit && <th className="p-4 font-semibold text-right no-print">Aksi</th>}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50">
                                        {filtered.length === 0 ? (
                                            <tr>
                                                <td colSpan="7" className="p-12 text-center text-slate-400">
                                                    <div className="flex flex-col items-center gap-2">
                                                        <Icon name="search-x" size={48} className="opacity-20" />
                                                        <p>Tidak ada bahan yang ditemukan.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        ) : filtered.map(item => (
                                            <tr key={item.id} className="hover:bg-slate-50/50 transition-colors group">
                                                <td className="p-4">
                                                    <div className="font-medium text-slate-900 group-hover:text-emerald-700 transition-colors">{item.name}</div>
                                                    <div className="text-xs text-slate-400 font-mono mt-0.5">ID: {item.id}</div>
                                                </td>
                                                {cols.category && <td className="p-4"><Badge>{item.category}</Badge></td>}
                                                {cols.price && <td className="p-4 text-slate-600 no-print">{formatRupiah(item.price)} <span className="text-slate-400">/{item.unit}</span></td>}
                                                {cols.stock && (
                                                    <td className="p-4 text-center">
                                                        <span className={`font-bold text-lg ${item.stock <= item.minStock ? 'text-rose-600' : 'text-slate-700'}`}>
                                                            {parseFloat(item.stock).toLocaleString('id-ID', { maximumFractionDigits: 3 })}
                                                        </span>
                                                        <span className="text-xs text-slate-400 ml-1">{item.unit}</span>
                                                    </td>
                                                )}
                                                <td className="p-4 border-b hidden print-only border-slate-200">
                                                    <div className="h-6 w-24 border-b border-slate-400 mx-auto"></div>
                                                </td>
                                                {cols.status && (
                                                    <td className="p-4 text-center no-print">
                                                        {item.stock <= item.minStock ? 
                                                            <Badge type="danger">Low Stock</Badge> : 
                                                            <Badge type="success">Tersedia</Badge>
                                                        }
                                                    </td>
                                                )}
                                                {cols.usedIn && (
                                                    <td className="p-4 no-print text-sm text-gray-600">
                                                        {(() => {
                                                            const usedIn = products.filter(p => p.recipe.some(r => r.itemId === item.id)).map(p => p.name);
                                                            return usedIn.length > 0 ? (
                                                                <div className="flex flex-wrap gap-1">
                                                                    {usedIn.slice(0, 3).map((name, i) => (
                                                                        <span key={i} className="inline-block px-2 py-0.5 bg-gray-100 text-gray-600 text-[10px] rounded-full border border-gray-200">
                                                                            {name}
                                                                        </span>
                                                                    ))}
                                                                    {usedIn.length > 3 && (
                                                                        <span className="inline-block px-2 py-0.5 bg-gray-50 text-gray-500 text-[10px] rounded-full border border-gray-100 italic">
                                                                            +{usedIn.length - 3} lainnya
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            ) : <span className="text-gray-400 text-xs italic">-</span>;
                                                        })()}
                                                    </td>
                                                )}
                                                {cols.action && canEdit && (
                                                    <td className="p-4 text-right no-print">
                                                        <div className="flex justify-end gap-2">
                                                            <Button variant="secondary" className="p-2 h-8 w-8 justify-center" onClick={() => { setEditingItem(item); setShowFormModal(true); }}>
                                                                <Icon name="edit-2" size={14} />
                                                            </Button>
                                                            <Button variant="secondary" className="p-2 h-8 w-8 justify-center text-rose-600 hover:bg-rose-50 hover:border-rose-200" onClick={() => handleDelete(item.id)}>
                                                                <Icon name="trash-2" size={14} />
                                                            </Button>
                                                        </div>
                                                    </td>
                                                )}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Opname Modal */}
                        <Modal isOpen={!!opnameItem} onClose={() => setOpnameItem(null)} title="Stok Opname (Penyesuaian Fisik)">
                            {opnameItem && (
                                <form onSubmit={handleOpnameSubmit} className="space-y-4">
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                                        <div className="flex justify-between mb-1">
                                            <span className="text-sm text-blue-800">Nama Bahan:</span>
                                            <span className="font-bold text-blue-900">{opnameItem.name}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className="text-sm text-blue-800">Stok di Sistem:</span>
                                            <span className="font-bold text-blue-900">{opnameItem.stock} {opnameItem.unit}</span>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium mb-1">Stok Fisik (Aktual)</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                step="0.001" 
                                                autoFocus
                                                required 
                                                className="flex-1 p-3 border-2 border-emerald-500 rounded-lg text-lg font-bold text-emerald-700 outline-none" 
                                                value={opnameActual} 
                                                onChange={e => setOpnameActual(e.target.value)} 
                                                placeholder="0"
                                            />
                                            <div className="flex items-center px-4 bg-gray-100 rounded-lg font-medium text-gray-500">
                                                {opnameItem.unit}
                                            </div>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-2">
                                            * Jika stok fisik lebih kecil dari sistem, selisih akan dicatat sebagai "Loss/Waste".<br/>
                                            * Jika lebih besar, akan dicatat sebagai "Surplus".
                                        </p>
                                    </div>

                                    <div className="pt-4 flex gap-2">
                                        <Button type="submit" className="flex-1 justify-center">Simpan Perubahan</Button>
                                        <Button variant="secondary" onClick={() => setOpnameItem(null)}>Batal</Button>
                                    </div>
                                </form>
                            )}
                        </Modal>
                    </div>
                );
            };

            const UsageView_Deprecated = () => {
                const [selectedItemId, setSelectedItemId] = useState("");
                const [filterText, setFilterText] = useState(""); // Search state
                const [isOpen, setIsOpen] = useState(false); // Dropdown visibility
                const [amount, setAmount] = useState("");
                const [reason, setReason] = useState("Produksi Harian");

                const selectedItem = inventory.find(i => i.id == selectedItemId);

                // Filter inventory based on search
                const filteredOptions = inventory
                    .filter(i => i.name.toLowerCase().includes(filterText.toLowerCase()))
                    .sort((a,b) => a.name.localeCompare(b.name));

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!selectedItemId) return showToast("Pilih barang dari daftar yang tersedia", 'error');
                    handleRecordUsage(selectedItemId, amount, reason);
                    setAmount("");
                    setReason("Produksi Harian");
                    setFilterText(""); 
                    setSelectedItemId("");
                    setIsOpen(false);
                };

                return (
                    <div className="max-w-4xl mx-auto space-y-8">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="clipboard-minus" className="text-emerald-600"></i>
                                    Pencatatan Pemakaian Bahan
                                </h2>
                                <p className="text-gray-500 text-sm mt-1">Input manual untuk bahan rusak, tumpah, atau sampling</p>
                            </div>
                            <Button variant="secondary" onClick={() => setView('list')}>
                                <Icon name="arrow-left" size={16} /> Kembali ke Stok
                            </Button>
                        </div>

                        <Card>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Pilih Bahan</label>
                                        <div className="relative">
                                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                                            <input 
                                                type="text" 
                                                placeholder="Cari atau pilih bahan..." 
                                                className={`w-full pl-9 pr-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none ${!selectedItemId && filterText ? 'border-amber-300 bg-amber-50' : 'border-gray-300'}`}
                                                value={filterText}
                                                onChange={e => { 
                                                    setFilterText(e.target.value); 
                                                    setSelectedItemId(""); 
                                                    setIsOpen(true);
                                                }}
                                                onFocus={() => setIsOpen(true)}
                                                onBlur={() => setTimeout(() => setIsOpen(false), 200)}
                                            />
                                            
                                            {/* Autocomplete Dropdown */}
                                            {isOpen && !selectedItemId && (
                                                <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                                                    {filteredOptions.length > 0 ? (
                                                        filteredOptions.map(item => (
                                                            <div 
                                                                key={item.id}
                                                                className="px-4 py-2.5 hover:bg-emerald-50 cursor-pointer border-b border-gray-50 last:border-0 group transition-colors"
                                                                onClick={() => {
                                                                    setSelectedItemId(item.id);
                                                                    setFilterText(item.name);
                                                                    setIsOpen(false);
                                                                }}
                                                            >
                                                                <div className="flex justify-between items-center">
                                                                    <span className="font-medium text-gray-800 group-hover:text-emerald-700">{item.name}</span>
                                                                    <span className={`text-xs px-2 py-0.5 rounded-full ${item.stock <= item.minStock ? 'bg-rose-100 text-rose-600' : 'bg-gray-100 text-gray-500'}`}>
                                                                        Sisa: {item.stock} {item.unit}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div className="p-3 text-sm text-gray-400 text-center italic">Bahan tidak ditemukan</div>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                        {!selectedItemId && filterText && (
                                            <p className="text-xs text-amber-600 mt-1 animate-pulse">* Silakan klik opsi di list untuk memilih</p>
                                        )}
                                    </div>
                                    
                                    {selectedItem && (
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-center gap-4 animate-in fade-in slide-in-from-top-2">
                                            <div className="bg-white p-2 rounded-full shadow-sm">
                                                <i data-lucide="package" className="text-blue-500"></i>
                                            </div>
                                            <div>
                                                <div className="text-sm text-gray-500">Stok Tersedia</div>
                                                <div className="text-lg font-bold text-gray-800">{selectedItem.stock} {selectedItem.unit}</div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Jumlah Terpakai</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" step="0.1" min="0" placeholder="0.0"
                                                className="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                                                value={amount} onChange={e => setAmount(e.target.value)} required
                                            />
                                            <div className="bg-gray-100 px-4 py-2.5 rounded-lg text-gray-500 font-medium border border-gray-200">
                                                {selectedItem ? selectedItem.unit : '-'}
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Keterangan / Alasan</label>
                                        <select 
                                            className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                                            value={reason} onChange={e => setReason(e.target.value)}
                                        >
                                            <option>Produksi Harian</option>
                                            <option>Bahan Rusak / Basi</option>
                                            <option>Spilled / Tumpah</option>
                                            <option>Sampling / Tester</option>
                                            <option>Lainnya</option>
                                        </select>
                                    </div>
                                    <Button type="submit" className="w-full justify-center mt-2" disabled={!selectedItem}>
                                        <i data-lucide="check-circle" className="w-4 h-4"></i> Konfirmasi Pengurangan
                                    </Button>
                                </div>
                            </form>
                        </Card>

                        {/* History Table */}
                        <div className="space-y-4">
                            <h3 className="font-bold text-gray-700">Riwayat Penggunaan Terakhir</h3>
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                                <table className="w-full text-left text-sm whitespace-nowrap">
                                    <thead className="bg-gray-50 text-gray-600">
                                        <tr>
                                            <th className="p-3">Waktu</th>
                                            <th className="p-3">Nama Bahan</th>
                                            <th className="p-3">Jumlah</th>
                                            <th className="p-3">Keterangan</th>
                                            <th className="p-3 text-right">Est. Biaya</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {usageLog.slice(0, 10).map(log => (
                                            <tr key={log.id} className="hover:bg-gray-50">
                                                <td className="p-3 text-gray-500">{formatDate(log.date)}</td>
                                                <td className="p-3 font-medium">{log.itemName}</td>
                                                <td className="p-3 font-bold text-rose-600">-{log.amount} {log.unit}</td>
                                                <td className="p-3 text-gray-600"><Badge>{log.reason}</Badge></td>
                                                <td className="p-3 text-right text-gray-500">{formatRupiah(log.cost)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const RestockView_Deprecated = () => {
                const [activeTab, setActiveTab] = useState('new'); // 'new' or 'list'
                const [editingRequestId, setEditingRequestId] = useState(null);
                const [filterMenuId, setFilterMenuId] = useState("all");
                const [selectedRestockItems, setSelectedRestockItems] = useState(new Set()); // Track checkboxes

                // Initialize cart with low stock items if empty
                useEffect(() => {
                    if (activeTab === 'new' && Object.keys(restockCart).length === 0 && !editingRequestId) {
                        const lowStock = {};
                        const newSelected = new Set();
                        let hasNew = false;
                        inventory.forEach(item => {
                            if (item.stock <= item.minStock) {
                                lowStock[item.id] = item.minStock * 2; // Suggest ordering double min stock
                                newSelected.add(item.id);
                                hasNew = true;
                            }
                        });
                        if (hasNew) {
                            setRestockCart(prev => ({ ...prev, ...lowStock }));
                            setSelectedRestockItems(newSelected);
                        }
                    }
                }, [activeTab, editingRequestId]);

                const filteredInventory = useMemo(() => {
                    if (filterMenuId === "all") return inventory;
                    const targetProduct = products.find(p => p.id === filterMenuId);
                    if (!targetProduct) return inventory;
                    
                    const ingredientIds = new Set(targetProduct.recipe.map(r => r.itemId));
                    return inventory.filter(i => ingredientIds.has(i.id));
                }, [inventory, products, filterMenuId]);

                // Toggle Selection (Checklist) only
                const toggleItem = (itemId) => {
                    setSelectedRestockItems(prev => {
                        const newSet = new Set(prev);
                        if (newSet.has(itemId)) newSet.delete(itemId);
                        else newSet.add(itemId);
                        return newSet;
                    });
                };

                const updateCart = (id, value) => {
                    const val = parseFloat(value);
                    setRestockCart(prev => ({ ...prev, [id]: val }));
                    
                    // Auto-select if value is typed and greater than 0
                    if (val > 0) {
                        setSelectedRestockItems(prev => {
                             const newSet = new Set(prev);
                             newSet.add(id);
                             return newSet;
                        });
                    }
                };

                const totalEstimation = inventory.reduce((acc, item) => {
                    if (!selectedRestockItems.has(item.id)) return acc;
                    const qty = parseFloat(restockCart[item.id]) || 0;
                    return acc + (qty * item.price);
                }, 0);

                const itemsInCart = inventory.filter(i => selectedRestockItems.has(i.id) && parseFloat(restockCart[i.id]) > 0).length;

                const handleSaveRequest = () => {
                    const itemsToOrder = inventory.filter(i => selectedRestockItems.has(i.id) && parseFloat(restockCart[i.id]) > 0).map(item => ({
                        id: item.id,
                        name: item.name,
                        unit: item.unit,
                        price: item.price,
                        qty: parseFloat(restockCart[item.id]),
                        isRealized: false 
                    }));

                    if (itemsToOrder.length === 0) return showToast("Pilih minimal 1 barang (Checklist & Qty > 0)", 'error');

                    if (editingRequestId) {
                        // Update Existing
                        setRequests(requests.map(req => req.id === editingRequestId ? {
                            ...req,
                            items: itemsToOrder,
                            totalEst: totalEstimation,
                            requester: `${req.requester} (Edited by ${user.name})`
                        } : req));
                        setEditingRequestId(null);
                        showToast("Request berhasil diperbarui!", 'success');
                    } else {
                        // Create New
                        const newRequest = {
                            id: `REQ-${Date.now().toString().slice(-6)}`,
                            date: new Date().toISOString(),
                            requester: user.name,
                            items: itemsToOrder,
                            totalEst: totalEstimation,
                            status: 'pending',
                            realizedBy: null,
                            realizedAt: null
                        };
                        setRequests([newRequest, ...requests]);
                        showToast("Request berhasil disimpan!", 'success');
                    }

                    setRestockCart({});
                    setSelectedRestockItems(new Set());
                    setActiveTab('list');
                };

                const handleEditRequest = (req) => {
                    const cart = {};
                    const selected = new Set();
                    req.items.forEach(item => {
                        cart[item.id] = item.qty;
                        selected.add(item.id);
                    });
                    setRestockCart(cart);
                    setSelectedRestockItems(selected);
                    setEditingRequestId(req.id);
                    setActiveTab('new');
                };

                const handleDeleteRequest = (id) => {
                    if (confirm("Hapus request ini secara permanen?")) {
                        setRequests(requests.filter(req => req.id !== id));
                        showToast("Request berhasil dihapus!", 'success');
                    }
                };

                const handleDeleteRequestItem = (reqId, itemId) => {
                    if (confirm("Hapus item ini dari request?")) {
                        setRequests(requests.map(req => {
                            if (req.id === reqId) {
                                return {
                                    ...req,
                                    items: req.items.filter(item => item.id !== itemId)
                                };
                            }
                            return req;
                        }));
                        showToast("Item berhasil dihapus!", 'success');
                    }
                };

                const handleUpdateItem = (reqId, itemId, field, value) => {
                    const val = parseFloat(value);
                    if (val < 0) return;

                    setRequests(requests.map(req => {
                        if (req.id === reqId) {
                            const updatedItems = req.items.map(item => 
                                item.id === itemId ? { ...item, [field]: isNaN(val) ? 0 : val } : item
                            );
                            const newTotal = updatedItems.reduce((acc, curr) => acc + (curr.qty * (curr.price || 0)), 0);
                            return { ...req, items: updatedItems, totalEst: newTotal };
                        }
                        return req;
                    }));
                };

                const toggleItemRealization = (reqId, itemId) => {
                    if (user.role !== 'ceo') return showToast("Hanya CEO yang bisa memvalidasi realisasi.", 'error');

                    let stockAdjustment = 0;
                    let targetItemId = null;

                    const updatedRequests = requests.map(req => {
                        if (req.id === reqId) {
                            const updatedItems = req.items.map(item => {
                                if (item.id === itemId) {
                                    // Determine stock action: Add if checking, Subtract if unchecking
                                    stockAdjustment = !item.isRealized ? item.qty : -item.qty;
                                    targetItemId = item.id;
                                    return { ...item, isRealized: !item.isRealized };
                                }
                                return item;
                            });

                            const allRealized = updatedItems.every(item => item.isRealized);
                            
                            return {
                                ...req,
                                items: updatedItems,
                                status: allRealized ? 'done' : 'pending',
                                realizedBy: allRealized ? user.name : (req.status === 'done' ? null : req.realizedBy),
                                realizedAt: allRealized ? new Date().toISOString() : null
                            };
                        }
                        return req;
                    });

                    setRequests(updatedRequests);

                    // Update Inventory Stock Automatically
                    if (targetItemId) {
                        setInventory(prevInventory => prevInventory.map(invItem => {
                            if (invItem.id === targetItemId) {
                                return { ...invItem, stock: invItem.stock + stockAdjustment };
                            }
                            return invItem;
                        }));
                    }
                };

                return (
                    <div className="h-[calc(100vh-100px)] flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">Pengadaan Stok</h2>
                                <p className="text-gray-500 text-sm">Susun daftar belanja untuk supplier</p>
                            </div>
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button onClick={() => { setActiveTab('new'); setEditingRequestId(null); setRestockCart({}); }} className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${activeTab === 'new' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                    {editingRequestId ? 'Mode Edit' : 'Buat Baru'}
                                </button>
                                <button onClick={() => setActiveTab('list')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${activeTab === 'list' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}>
                                    Daftar Request
                                    {requests.filter(r => r.status === 'pending').length > 0 && (
                                        <span className="bg-rose-500 text-white text-[10px] px-1.5 rounded-full">{requests.filter(r => r.status === 'pending').length}</span>
                                    )}
                                </button>
                            </div>
                        </div>

                        {activeTab === 'new' ? (
                            <>
                                <div className="flex flex-col md:flex-row items-start md:items-center gap-4 bg-white p-3 pr-4 rounded-xl border border-gray-200 shadow-sm mb-4 justify-between sticky top-0 z-20">
                                    <div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 w-full md:w-auto">
                                        <div className="flex justify-between items-center w-full md:w-auto">
                                            <div className="px-3 py-2 bg-emerald-50 rounded-lg text-emerald-700 font-bold border border-emerald-100 text-sm whitespace-nowrap">
                                                Total: {formatRupiah(totalEstimation)}
                                            </div>
                                            {/* Mobile Save Button (Visible only on small screens) */}
                                            <div className="md:hidden flex gap-2">
                                                <Button size="sm" onClick={handleSaveRequest} disabled={itemsInCart === 0} className="px-3 py-2 text-xs">
                                                    <Icon name="save" size={16} /> Simpan
                                                </Button>
                                            </div>
                                        </div>
                                        <select 
                                            className="w-full md:w-48 p-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm text-sm"
                                            value={filterMenuId} onChange={e => setFilterMenuId(e.target.value)}
                                        >
                                            <option value="all">Semua Bahan</option>
                                            {products.map(p => (
                                                <option key={p.id} value={p.id}>{p.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="hidden md:flex gap-2">
                                        <Button variant="outline" onClick={handleSendRestock} disabled={itemsInCart === 0}>
                                            <Icon name="share-2" size={18} /> Share WA
                                        </Button>
                                        <Button onClick={handleSaveRequest} disabled={itemsInCart === 0}>
                                            <Icon name="save" size={18} /> {editingRequestId ? 'Update Request' : 'Simpan Request'}
                                        </Button>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-auto bg-gray-50 md:bg-white rounded-xl shadow-none md:shadow-sm md:border border-gray-200">
                                    {/* Desktop Table */}
                                    <table className="hidden md:table w-full text-left text-sm sticky top-0">
                                        <thead className="bg-gray-100 text-gray-700 font-bold z-10 sticky top-0 shadow-sm">
                                            <tr>
                                                <th className="p-4 w-12 text-center">
                                                    <Icon name="check-square" size={18} />
                                                </th>
                                                <th className="p-4 w-1/3">Nama Bahan</th>
                                                <th className="p-4 whitespace-nowrap">Stok Saat Ini</th>
                                                <th className="p-4">Status</th>
                                                <th className="p-4 w-32">Qty Order</th>
                                                <th className="p-4 text-right">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {filteredInventory.map(item => (
                                                <tr key={item.id} className={restockCart[item.id] !== undefined ? "bg-emerald-50/30" : "hover:bg-gray-50"}>
                                                    <td className="p-4 text-center">
                                                        <input 
                                                            type="checkbox" 
                                                            className="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                                                            checked={selectedRestockItems.has(item.id)}
                                                            onChange={() => toggleItem(item.id)}
                                                        />
                                                    </td>
                                                    <td className="p-4">
                                                        <div className="font-medium">{item.name}</div>
                                                        <div className="text-xs text-gray-500">Harga: {formatRupiah(item.price)}/{item.unit}</div>
                                                    </td>
                                                    <td className="p-4">
                                                        <div className="whitespace-nowrap">
                                                            <span className="font-bold text-gray-800">{parseFloat(item.stock).toLocaleString('id-ID', { maximumFractionDigits: 3 })}</span>
                                                            <span className="ml-1 text-xs text-gray-500">{item.unit}</span>
                                                        </div>
                                                    </td>
                                                    <td className="p-4">
                                                        {item.stock <= item.minStock && <Badge type="danger">Perlu Restock</Badge>}
                                                    </td>
                                                    <td className="p-4">
                                                        <div className="flex items-center">
                                                            <input 
                                                                type="number" min="0" step="any"
                                                                className={`w-24 p-2 text-center border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none ${selectedRestockItems.has(item.id) ? 'border-emerald-500 font-bold bg-white' : 'border-gray-200 bg-gray-50'}`}
                                                                placeholder="0"
                                                                value={restockCart[item.id] || ''}
                                                                onChange={e => updateCart(item.id, e.target.value)}
                                                            />
                                                            <span className="ml-2 text-gray-500 text-xs">{item.unit}</span>
                                                        </div>
                                                    </td>
                                                    <td className="p-4 text-right font-medium text-gray-700">
                                                        {formatRupiah((parseFloat(restockCart[item.id]) || 0) * item.price)}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>

                                    {/* Mobile Card List */}
                                    <div className="md:hidden space-y-3 pb-20">
                                        {filteredInventory.map(item => {
                                            const qty = parseFloat(restockCart[item.id]);
                                            const isActive = selectedRestockItems.has(item.id);
                                            return (
                                                <div key={item.id} className={`bg-white p-4 rounded-xl border ${isActive ? 'border-emerald-500 shadow-emerald-100 shadow-md' : 'border-gray-200'}`}>
                                                    <div className="flex gap-3 mb-3">
                                                        <div className="pt-1">
                                                            <input 
                                                                type="checkbox" 
                                                                className="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                                                                checked={isActive}
                                                                onChange={() => toggleItem(item.id)}
                                                            />
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between items-start">
                                                                <div>
                                                                    <div className="font-bold text-gray-900">{item.name}</div>
                                                                    <div className="text-xs text-gray-500">{formatRupiah(item.price)} / {item.unit}</div>
                                                                </div>
                                                                {item.stock <= item.minStock && <Badge type="danger">Low</Badge>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-center justify-between gap-4 pl-8">
                                                        <div className="text-xs text-gray-500 flex flex-col sm:flex-row sm:items-center gap-1">
                                                            <span>Stok:</span> 
                                                            <span className="font-bold text-gray-800 whitespace-nowrap">
                                                                {parseFloat(item.stock).toLocaleString('id-ID', { maximumFractionDigits: 3 })} {item.unit}
                                                            </span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <input 
                                                                type="number" min="0" step="any"
                                                                className={`w-20 p-2 text-center border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm ${isActive ? 'border-emerald-500 font-bold text-emerald-700 bg-emerald-50' : 'border-gray-200'}`}
                                                                placeholder="0"
                                                                value={restockCart[item.id] || ''}
                                                                onChange={e => updateCart(item.id, e.target.value)}
                                                            />
                                                            <span className="text-xs text-gray-400">{item.unit}</span>
                                                        </div>
                                                    </div>
                                                    {isActive && (
                                                        <div className="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center pl-8">
                                                            <span className="text-xs text-emerald-600 font-medium">Subtotal</span>
                                                            <span className="text-sm font-bold text-emerald-700">{formatRupiah(qty * item.price)}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 overflow-auto space-y-4">
                                {requests.length === 0 && (
                                    <div className="text-center py-12 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                                        <Icon name="inbox" size={48} className="mx-auto mb-4 opacity-20" />
                                        <p>Belum ada request restock.</p>
                                    </div>
                                )}
                                {requests.map(req => (
                                    <Card key={req.id} className={`transition-all ${req.status === 'done' ? 'opacity-60 bg-gray-50' : 'border-l-4 border-l-emerald-500'}`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <div className="flex items-center gap-3">
                                                    <h3 className="font-bold text-lg text-gray-800">{req.id}</h3>
                                                    <Badge type={req.status === 'done' ? 'success' : 'warning'}>
                                                        {req.status === 'done' ? 'Terealisasi' : 'Menunggu Realisasi'}
                                                    </Badge>
                                                </div>
                                                <div className="text-xs text-gray-500 mt-1">
                                                    Dibuat oleh <b>{req.requester}</b> pada {formatDate(req.date)}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-lg text-emerald-600">{formatRupiah(req.totalEst)}</div>
                                                <div className="flex gap-2 justify-end mt-1">
                                                    {/* Show Edit Button if no items are realized yet */}
                                                    {!req.items.some(i => i.isRealized) && (
                                                        <button onClick={() => handleEditRequest(req)} className="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 bg-blue-50 px-2 py-1 rounded">
                                                            <Icon name="edit-3" size={12} /> Edit
                                                        </button>
                                                    )}
                                                    {(user.role === 'owner' || user.role === 'ceo') && (
                                                        <button onClick={() => handleDeleteRequest(req.id)} className="text-xs flex items-center gap-1 text-rose-600 hover:text-rose-800 bg-rose-50 px-2 py-1 rounded">
                                                            <Icon name="trash-2" size={12} /> Hapus
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-gray-50 rounded-lg p-3 mb-4">
                                            <ul className="text-sm space-y-2">
                                                {req.items.map((item, idx) => (
                                                    <li key={idx} className="flex justify-between items-center p-2 bg-white rounded border border-gray-100">
                                                        <div className="flex items-center gap-2">
                                                            {user.role === 'ceo' ? (
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={item.isRealized || false} 
                                                                    onChange={() => toggleItemRealization(req.id, item.id)}
                                                                    className="w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer"
                                                                />
                                                            ) : (
                                                                item.isRealized && <Icon name="check-circle" size={14} className="text-emerald-500" />
                                                            )}
                                                            <span className={item.isRealized ? "text-gray-400 line-through" : "text-gray-700"}>{item.name}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <div className="flex items-center text-xs text-gray-500 bg-gray-50 rounded px-2 py-1" title="Harga Satuan">
                                                                <span className="mr-1">Rp</span>
                                                                <input 
                                                                    type="number" 
                                                                    className="w-20 bg-transparent text-right outline-none border-b border-gray-300 focus:border-emerald-500"
                                                                    value={item.price}
                                                                    onChange={(e) => handleUpdateItem(req.id, item.id, 'price', e.target.value)}
                                                                    disabled={user.role === 'staff' && item.isRealized}
                                                                />
                                                            </div>
                                                            <div className="flex items-center text-xs text-gray-500 bg-gray-50 rounded px-2 py-1" title="Volume/Qty">
                                                                <input 
                                                                    type="number" step="any"
                                                                    className="w-12 bg-transparent text-center outline-none border-b border-gray-300 focus:border-emerald-500 font-medium text-gray-700"
                                                                    value={item.qty}
                                                                    onChange={(e) => handleUpdateItem(req.id, item.id, 'qty', e.target.value)}
                                                                    disabled={user.role === 'staff' && item.isRealized}
                                                                />
                                                                <span className="ml-1 text-gray-400">{item.unit}</span>
                                                            </div>
                                                            {(user.role === 'owner' || user.role === 'ceo') && !item.isRealized && (
                                                                <button onClick={() => handleDeleteRequestItem(req.id, item.id)} className="text-rose-400 hover:text-rose-600 p-1 rounded hover:bg-rose-50" title="Hapus Item">
                                                                    <Icon name="trash-2" size={14} />
                                                                </button>
                                                            )}
                                                        </div>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        <div className="flex justify-between items-center pt-2 border-t border-gray-100">
                                            <div className="text-xs text-gray-500">
                                                {req.status === 'done' ? (
                                                    <span className="flex items-center gap-1 text-emerald-600 font-medium">
                                                        <Icon name="check-circle" size={14} /> Selesai direalisasi {req.realizedBy ? `oleh ${req.realizedBy}` : ''}
                                                    </span>
                                                ) : (
                                                    <span className="text-amber-600">Proses Realisasi ({req.items.filter(i => i.isRealized).length}/{req.items.length} item)</span>
                                                )}
                                            </div>
                                            {user.role !== 'ceo' && req.status !== 'done' && (
                                                <span className="text-xs text-gray-400 italic">Menunggu konfirmasi CEO</span>
                                            )}
                                        </div>
                                    </Card>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            const ProductView_Deprecated = () => {
                const [isEditing, setIsEditing] = useState(false);
                const [tempProduct, setTempProduct] = useState(null);
                const [productionQty, setProductionQty] = useState({}); // { productId: qty }

                useEffect(() => {
                    lucide.createIcons();
                }, [isEditing, tempProduct]);

                const startEdit = (product) => {
                    setTempProduct(JSON.parse(JSON.stringify(product || {
                        id: "", name: "", overhead: 0, sellingPrice: 0, recipe: []
                    })));
                    setIsEditing(true);
                };

                const saveProduct = () => {
                    if (!tempProduct.name) return showToast("Nama produk wajib diisi", 'error');
                    if (tempProduct.recipe.length === 0) return showToast("Minimal harus ada 1 bahan baku", 'error');
                    
                    const newProd = { ...tempProduct, id: tempProduct.id || generateId() };
                    
                    if (tempProduct.id) {
                        setProducts(products.map(p => p.id === newProd.id ? newProd : p));
                    } else {
                        setProducts([...products, newProd]);
                    }
                    setIsEditing(false);
                    showToast("Resep berhasil disimpan!", 'success');
                };

                const deleteProduct = (id) => {
                    if (confirm("Hapus produk ini?")) {
                        setProducts(products.filter(p => p.id !== id));
                    }
                };

                const addIngredient = () => {
                    setTempProduct({
                        ...tempProduct,
                        recipe: [...tempProduct.recipe, { itemId: inventory[0]?.id || "", qty: 1 }]
                    });
                };

                const removeIngredient = (idx) => {
                    const newRecipe = [...tempProduct.recipe];
                    newRecipe.splice(idx, 1);
                    setTempProduct({ ...tempProduct, recipe: newRecipe });
                };

                const updateIngredient = (idx, field, value) => {
                    const newRecipe = [...tempProduct.recipe];
                    newRecipe[idx] = { ...newRecipe[idx], [field]: value };
                    setTempProduct({ ...tempProduct, recipe: newRecipe });
                };

                const calcTempHPP = () => {
                    if (!tempProduct) return 0;
                    return tempProduct.recipe.reduce((total, ing) => {
                        const item = inventory.find(i => i.id === ing.itemId);
                        return total + (item ? item.price * ing.qty : 0);
                    }, 0) + (parseFloat(tempProduct.overhead) || 0);
                };

                if (isEditing) {
                    return (
                        <Card className="max-w-3xl mx-auto">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold">{tempProduct.id ? "Edit Resep Produk" : "Buat Resep Baru"}</h2>
                                <button onClick={() => setIsEditing(false)}><Icon name="x" size={24} /></button>
                            </div>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Nama Produk / Menu</label>
                                    <input type="text" className="w-full p-2 border rounded-lg" 
                                        value={tempProduct.name} onChange={e => setTempProduct({...tempProduct, name: e.target.value})} placeholder="Contoh: Kopi Susu" 
                                        readOnly={!canEdit} />
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-medium">Bahan Baku (Resep)</label>
                                        {canEdit && (
                                            <Button variant="secondary" onClick={addIngredient} className="text-xs py-1"><Icon name="plus" size={16} /> Tambah Bahan</Button>
                                        )}
                                    </div>
                                    <div className="space-y-2 bg-gray-50 p-4 rounded-xl border border-gray-200">
                                        {tempProduct.recipe.length === 0 && <p className="text-center text-gray-400 text-sm">Belum ada bahan baku dipilih</p>}
                                        {tempProduct.recipe.map((ing, idx) => {
                                            const item = inventory.find(i => i.id === ing.itemId);
                                            const subtotal = item ? item.price * ing.qty : 0;
                                            return (
                                                <div key={idx} className="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col md:flex-row md:items-center gap-3 transition-all hover:border-emerald-200">
                                                    {/* Selection Area */}
                                                    <div className="flex-1">
                                                        <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 md:hidden">Pilih Bahan</label>
                                                        <select 
                                                            className="w-full p-2.5 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" 
                                                            value={ing.itemId} 
                                                            onChange={e => updateIngredient(idx, 'itemId', e.target.value)}
                                                            disabled={!canEdit}
                                                        >
                                                            {inventory.map(item => (
                                                                <option key={item.id} value={item.id}>{item.name} (@ {formatRupiah(item.price)}/{item.unit})</option>
                                                            ))}
                                                        </select>
                                                    </div>

                                                    {/* Qty & Price Area */}
                                                    <div className="flex items-center justify-between md:justify-end gap-3 w-full md:w-auto">
                                                        <div className="flex items-center gap-2">
                                                            <div className="w-24">
                                                                <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 md:hidden">Jumlah</label>
                                                                <input 
                                                                    type="number" step="any" min="0" 
                                                                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-emerald-500 outline-none font-medium"
                                                                    value={ing.qty} 
                                                                    onChange={e => updateIngredient(idx, 'qty', parseFloat(e.target.value))} 
                                                                    placeholder="0"
                                                                    readOnly={!canEdit} 
                                                                />
                                                            </div>
                                                            <span className="text-sm text-gray-500 font-medium pt-4 md:pt-0 w-8">
                                                                {item?.unit || '-'}
                                                            </span>
                                                        </div>

                                                        <div className="flex items-center gap-3 border-l md:border-l-0 pl-3 md:pl-0 border-gray-100">
                                                            <div className="text-right min-w-[80px]">
                                                                <label className="text-[10px] uppercase font-bold text-gray-400 mb-1 md:hidden">Subtotal</label>
                                                                <div className="font-bold text-gray-700 text-sm">{formatRupiah(subtotal)}</div>
                                                            </div>
                                                            
                                                            {canEdit && (
                                                                <button 
                                                                    onClick={() => removeIngredient(idx)} 
                                                                    className="text-rose-500 hover:text-rose-700 hover:bg-rose-50 p-2 rounded-lg transition-colors mt-4 md:mt-0" 
                                                                    title="Hapus Bahan"
                                                                >
                                                                    <Icon name="trash-2" size={18} />
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Harga Jual (IDR)</label>
                                        <input type="number" className="w-full p-2 border rounded-lg" 
                                            value={tempProduct.sellingPrice} onChange={e => setTempProduct({...tempProduct, sellingPrice: parseFloat(e.target.value)})} placeholder="0" 
                                            readOnly={!canEdit} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Biaya Lain/Overhead (IDR)</label>
                                        <input type="number" className="w-full p-2 border rounded-lg" 
                                            value={tempProduct.overhead} onChange={e => setTempProduct({...tempProduct, overhead: parseFloat(e.target.value)})} placeholder="0" 
                                            readOnly={!canEdit} />
                                        <p className="text-xs text-gray-400 mt-1">Biaya packaging, listrik, dll per porsi.</p>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-6 pt-4 border-t border-gray-100">
                                    <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                        <div className="text-sm text-emerald-800 mb-1">Total HPP per Porsi</div>
                                        <div className="text-2xl font-bold text-emerald-600">{formatRupiah(calcTempHPP())}</div>
                                    </div>
                                    <div className={`p-4 rounded-xl border ${ (tempProduct.sellingPrice - calcTempHPP()) > 0 ? 'bg-blue-50 border-blue-100' : 'bg-rose-50 border-rose-100'}`}>
                                        <div className="text-sm text-gray-800 mb-1">Margin Profit</div>
                                        <div className={`text-2xl font-bold ${ (tempProduct.sellingPrice - calcTempHPP()) > 0 ? 'text-blue-600' : 'text-rose-600'}`}>
                                            {formatRupiah(tempProduct.sellingPrice - calcTempHPP())}
                                        </div>
                                    </div>
                                </div>

                                {canEdit && (
                                    <div className="flex gap-3 pt-4 border-t">
                                        <Button onClick={saveProduct} className="flex-1 justify-center">Simpan Resep</Button>
                                        <Button variant="secondary" onClick={() => setIsEditing(false)}>Batal</Button>
                                    </div>
                                )}
                            </div>
                        </Card>
                    );
                }

                return (
                    <div className="space-y-6">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold text-gray-800">Daftar Menu Resep</h2>
                            {canEdit && (
                                <Button onClick={() => startEdit(null)}><Icon name="plus" size={20} /> Buat Menu Baru</Button>
                            )}
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {products.map(product => {
                                const hpp = calculateHPP(product);
                                const maxStock = Math.min(...product.recipe.map(ing => {
                                    const item = inventory.find(i => i.id === ing.itemId);
                                    return item ? Math.floor(item.stock / ing.qty) : 0;
                                }));
                                
                                return (
                                    <Card key={product.id} className="relative flex flex-col">
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <h3 className="font-bold text-lg text-gray-900">{product.name}</h3>
                                                <div className="text-sm text-gray-500">{product.recipe.length} Bahan Baku</div>
                                            </div>
                                            <div className="flex gap-1">
                                                <button onClick={() => startEdit(product)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded"><Icon name={canEdit ? "edit-2" : "eye"} size={16} /></button>
                                                {canEdit && (
                                                    <button onClick={() => deleteProduct(product.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded"><Icon name="trash-2" size={16} /></button>
                                                )}
                                            </div>
                                        </div>

                                        <div className="space-y-3 flex-1">
                                            <div className="flex justify-between items-center py-2 border-y border-gray-100">
                                                <div className="text-center flex-1 border-r border-gray-100">
                                                    <div className="text-[10px] text-gray-500 uppercase">HPP</div>
                                                    <div className="font-bold text-gray-700">{formatRupiah(hpp)}</div>
                                                </div>
                                                <div className="text-center flex-1">
                                                    <div className="text-[10px] text-gray-500 uppercase">Jual</div>
                                                    <div className="font-bold text-emerald-600">{formatRupiah(product.sellingPrice || 0)}</div>
                                                </div>
                                            </div>
                                            
                                            <div className="text-xs text-gray-500">
                                                <div className="font-semibold mb-1">Bahan Utama:</div>
                                                <ul className="list-disc pl-4 space-y-0.5">
                                                    {product.recipe.slice(0, 3).map((r, i) => {
                                                        const item = inventory.find(x => x.id === r.itemId);
                                                        return <li key={i}>{item?.name} ({r.qty} {item?.unit})</li>
                                                    })}
                                                    {product.recipe.length > 3 && <li>...dan {product.recipe.length - 3} lainnya</li>}
                                                </ul>
                                            </div>
                                        </div>

                                        <div className="mt-6 pt-4 border-t border-gray-100">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-xs font-semibold text-gray-500">PRODUKSI / JUAL</span>
                                                <span className="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">Max: {maxStock} porsi</span>
                                            </div>
                                            <div className="flex gap-2">
                                                <input 
                                                    type="number" min="1" 
                                                    className="w-16 p-2 border rounded-lg text-center text-sm" 
                                                    placeholder="Qty"
                                                    value={productionQty[product.id] || ''}
                                                    onChange={e => setProductionQty({...productionQty, [product.id]: parseInt(e.target.value)})}
                                                />
                                                <Button onClick={() => handleProduce(product, productionQty[product.id] || 0)} className="flex-1 justify-center text-sm py-2">
                                                    <i data-lucide="check-circle" className="w-4 h-4"></i> Catat
                                                </Button>
                                            </div>
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const FinanceView_Deprecated = () => {
                // Default to current month start - today
                const [startDate, setStartDate] = useState(() => {
                    const date = new Date();
                    return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().slice(0, 10);
                });
                const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
                
                const [operationalCost, setOperationalCost] = useState(0); 

                // Filter logs based on date range
                const filteredLogs = useMemo(() => {
                    return usageLog.filter(log => {
                        const logDate = log.date.slice(0, 10);
                        return logDate >= startDate && logDate <= endDate;
                    });
                }, [usageLog, startDate, endDate]);

                // Financial Calculations
                const financeStats = useMemo(() => {
                    let revenue = 0;
                    let cogs = 0; // HPP
                    let waste = 0; // Spilled/Expired

                    filteredLogs.forEach(log => {
                        if (log.reason && log.reason.toLowerCase().includes("produksi")) {
                            let itemRevenue = log.revenue;
                            if (itemRevenue === undefined || itemRevenue === null) {
                                const prod = products.find(p => p.id === log.itemId);
                                itemRevenue = prod ? (prod.sellingPrice || 0) * log.amount : 0;
                            }
                            revenue += itemRevenue;
                            cogs += log.cost;
                        } else {
                            waste += log.cost;
                        }
                    });

                    const grossProfit = revenue - cogs;
                    const netProfit = grossProfit - waste - operationalCost;

                    return { revenue, cogs, waste, grossProfit, netProfit };
                }, [filteredLogs, operationalCost, products]);

                // Helper for Period Display
                const getPeriodString = () => {
                    const start = new Date(startDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                    const end = new Date(endDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                    return `${start} - ${end}`;
                };

                // Export Functions
                const handleExportCSV = () => {
                    const escapeCsv = (str) => `"${String(str).replace(/"/g, '""')}"`;

                    const rows = [
                        ["RINGKASAN LABA RUGI"],
                        [`Periode: ${getPeriodString()}`],
                        [""],
                        ["KETERANGAN", "NILAI (IDR)"],
                        ["Pendapatan (Revenue)", financeStats.revenue],
                        ["Harga Pokok Penjualan (COGS)", -financeStats.cogs],
                        ["LABA KOTOR", financeStats.grossProfit],
                        [""],
                        ["Beban Waste/Rusak", -financeStats.waste],
                        ["Beban Operasional", -operationalCost],
                        ["TOTAL BEBAN", -(financeStats.waste + operationalCost)],
                        [""],
                        ["LABA BERSIH (NET PROFIT)", financeStats.netProfit]
                    ];

                    const csvContent = rows.map(e => e.map(escapeCsv).join(",")).join("\n");
                    const link = document.createElement("a");
                    link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
                    link.download = `Ringkasan_Keuangan_${startDate}_to_${endDate}.csv`;
                    link.click();
                };

                const handleDownloadRecap = () => {
                    const escapeCsv = (str) => `"${String(str || '').replace(/"/g, '""')}"`;

                    // 1. Sales Data
                    const salesData = filteredLogs.filter(l => l.reason.toLowerCase().includes("produksi")).map(l => [
                        formatDate(l.date), l.itemName, l.amount, l.unit, l.cost, (l.revenue || 0)
                    ]);

                    // 2. Restock/Shopping Data (Realized Requests in this range)
                    const realizedRequests = requests.filter(r => {
                        if (r.status !== 'done' || !r.realizedAt) return false;
                        const rDate = r.realizedAt.slice(0, 10);
                        return rDate >= startDate && rDate <= endDate;
                    });
                    
                    const shoppingData = [];
                    realizedRequests.forEach(req => {
                        req.items.forEach(item => {
                            shoppingData.push([
                                formatDate(req.realizedAt), req.id, item.name, item.qty, item.unit, item.price, (item.qty * item.price)
                            ]);
                        });
                    });

                    // 3. Waste Data
                    const wasteData = filteredLogs.filter(l => !l.reason.toLowerCase().includes("produksi")).map(l => [
                        formatDate(l.date), l.itemName, l.amount, l.unit, l.reason, l.cost
                    ]);

                    let csvContent = `REKAPITULASI KEUANGAN DETAIL - ${getPeriodString().toUpperCase()}\n\n`;
                    
                    // Section 1: Summary
                    csvContent += `I. RINGKASAN\nKeterangan,Nilai (IDR)\n`;
                    csvContent += `Total Penjualan,${financeStats.revenue}\n`;
                    csvContent += `Total HPP (Bahan Terpakai),${financeStats.cogs}\n`;
                    csvContent += `Total Belanja (Restock),${shoppingData.reduce((sum, row) => sum + row[6], 0)}\n`;
                    csvContent += `Total Waste,${financeStats.waste}\n`;
                    csvContent += `Biaya Operasional,${operationalCost}\n`;
                    csvContent += `Net Profit,${financeStats.netProfit}\n\n`;

                    // Section 2: Sales
                    csvContent += `II. DETAIL PENJUALAN (PRODUKSI)\nTanggal,Menu,Qty,Unit,HPP Total,Revenue\n`;
                    csvContent += salesData.map(r => r.map(escapeCsv).join(",")).join("\n") + "\n\n";

                    // Section 3: Shopping
                    csvContent += `III. DETAIL BELANJA (RESTOCK)\nTanggal,No.Request,Item,Qty,Unit,Harga Satuan,Total\n`;
                    csvContent += shoppingData.map(r => r.map(escapeCsv).join(",")).join("\n") + "\n\n";

                    // Section 4: Waste
                    csvContent += `IV. DETAIL WASTE & LAINNYA\nTanggal,Item,Qty,Unit,Alasan,Nilai Kerugian\n`;
                    csvContent += wasteData.map(r => r.map(escapeCsv).join(",")).join("\n");

                    const link = document.createElement("a");
                    link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
                    link.download = `Rekap_Lengkap_${startDate}_to_${endDate}.csv`;
                    link.click();
                };

                const handlePrintReport = () => {
                    const printWindow = window.open('', '', 'width=800,height=900');
                    if(!printWindow) return showToast("Pop-up diblokir browser!", 'error');

                    const htmlContent = `
                        <html>
                        <head>
                            <title>Laporan Keuangan - ${getPeriodString()}</title>
                            <style>
                                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; color: #1e293b; line-height: 1.5; }
                                .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; }
                                .header h1 { margin: 0; font-size: 24px; text-transform: uppercase; color: #0f172a; }
                                .header p { margin: 5px 0 0; color: #64748b; font-size: 14px; }
                                .section-title { font-size: 14px; font-weight: bold; color: #475569; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
                                .row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
                                .row:not(:last-child) { border-bottom: 1px dashed #e2e8f0; }
                                .row.highlight { font-weight: 600; background-color: #f8fafc; padding: 10px; border-radius: 4px; margin-top: 5px; }
                                .row.total { font-size: 18px; font-weight: 700; background-color: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #cbd5e1; }
                                .value { font-family: 'Courier New', monospace; font-weight: 600; }
                                .text-red { color: #ef4444; }
                                .text-green { color: #10b981; }
                                .signatures { display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px; }
                                .sig-box { text-align: center; width: 200px; }
                                .sig-line { border-top: 1px solid #94a3b8; margin-top: 60px; font-weight: 600; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>Laporan Laba Rugi</h1>
                                <p>Periode: ${getPeriodString()}</p>
                                <p>Dicetak: ${new Date().toLocaleDateString('id-ID')} oleh ${user.name}</p>
                            </div>

                            <div class="section-title">Pendapatan</div>
                            <div class="row">
                                <span>Penjualan Bersih (Revenue)</span>
                                <span class="value">${formatRupiah(financeStats.revenue)}</span>
                            </div>
                            <div class="row">
                                <span>Harga Pokok Penjualan (HPP)</span>
                                <span class="value text-red">(${formatRupiah(financeStats.cogs)})</span>
                            </div>
                            <div class="row highlight">
                                <span>LABA KOTOR</span>
                                <span class="value">${formatRupiah(financeStats.grossProfit)}</span>
                            </div>

                            <div style="margin-top: 20px;"></div>
                            <div class="section-title">Beban Operasional</div>
                            <div class="row">
                                <span>Waste / Bahan Rusak</span>
                                <span class="value text-red">(${formatRupiah(financeStats.waste)})</span>
                            </div>
                            <div class="row">
                                <span>Biaya Operasional (Total Periode)</span>
                                <span class="value text-red">(${formatRupiah(operationalCost)})</span>
                            </div>
                            
                            <div class="row total">
                                <span>LABA BERSIH (NET PROFIT)</span>
                                <span class="value ${financeStats.netProfit >= 0 ? 'text-green' : 'text-red'}">
                                    ${formatRupiah(financeStats.netProfit)}
                                </span>
                            </div>

                            <div class="signatures">
                                <div class="sig-box">
                                    Dibuat Oleh
                                    <div class="sig-line">${user.name}</div>
                                </div>
                                <div class="sig-box">
                                    Disetujui Oleh
                                    <div class="sig-line">Owner / Manager</div>
                                </div>
                            </div>
                            <script>window.onload = function() { window.print(); };<\/script>
                        </body>
                        </html>
                    `;
                    printWindow.document.write(htmlContent);
                    printWindow.document.close();
                };

                return (
                    <div className="space-y-8 animate-in fade-in duration-500">
                        {/* Header & Controls */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800 tracking-tight">Laporan Keuangan</h2>
                                <p className="text-slate-500 mt-1">Pantau performa bisnis dan arus kas.</p>
                            </div>
                            
                            <div className="flex flex-wrap items-end gap-4 w-full md:w-auto bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Periode Tanggal</label>
                                    <div className="flex items-center gap-2">
                                        <input 
                                            type="date" 
                                            className="px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                                            value={startDate}
                                            onChange={e => setStartDate(e.target.value)}
                                        />
                                        <span className="text-slate-400 font-bold">-</span>
                                        <input 
                                            type="date" 
                                            className="px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                                            value={endDate}
                                            onChange={e => setEndDate(e.target.value)}
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-[10px] uppercase font-bold text-slate-400 block mb-1">Biaya Ops (Total Periode)</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">Rp</span>
                                        <input 
                                            type="number" 
                                            className="pl-8 pr-3 py-2 w-32 bg-white border border-slate-200 rounded-lg text-sm font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-emerald-500 shadow-sm"
                                            placeholder="0"
                                            value={operationalCost || ''}
                                            onChange={e => setOperationalCost(parseFloat(e.target.value) || 0)}
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2 ml-auto md:ml-0">
                                    <div className="relative group">
                                        <Button variant="secondary" className="h-[38px]">
                                            <Icon name="download" size={16} /> Laporan
                                        </Button>
                                        <div className="absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-xl border border-slate-100 p-2 hidden group-hover:block z-20 animate-in slide-in-from-top-2">
                                            <button onClick={handleExportCSV} className="w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm flex items-center gap-2 text-slate-600">
                                                <Icon name="file-text" size={14} /> Ringkasan (CSV)
                                            </button>
                                            <button onClick={handleDownloadRecap} className="w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm flex items-center gap-2 text-slate-600">
                                                <Icon name="table" size={14} /> Rekap Lengkap (CSV)
                                            </button>
                                            <div className="h-px bg-slate-100 my-1"></div>
                                            <button onClick={handlePrintReport} className="w-full text-left px-3 py-2 hover:bg-slate-50 rounded-lg text-sm flex items-center gap-2 text-slate-600">
                                                <Icon name="printer" size={14} /> Print PDF
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                            {[
                                { title: "Pendapatan", value: financeStats.revenue, icon: "wallet", color: "emerald", sub: "Total omzet kotor" },
                                { title: "HPP & Modal", value: financeStats.cogs, icon: "shopping-bag", color: "blue", sub: "Biaya bahan baku" },
                                { title: "Beban & Waste", value: financeStats.waste + operationalCost, icon: "trending-down", color: "rose", sub: `Waste: ${formatRupiah(financeStats.waste)}` },
                                { title: "Laba Bersih", value: financeStats.netProfit, icon: "pie-chart", color: financeStats.netProfit >= 0 ? "indigo" : "amber", sub: "Net Profit" }
                            ].map((stat, i) => (
                                <div key={i} className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm relative overflow-hidden group hover:shadow-md transition-all">
                                    <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-${stat.color}-600`}>
                                        <Icon name={stat.icon} size={64} />
                                    </div>
                                    <div className="relative z-10">
                                        <div className={`inline-flex p-2.5 rounded-xl bg-${stat.color}-50 text-${stat.color}-600 mb-4`}>
                                            <Icon name={stat.icon} size={20} />
                                        </div>
                                        <div className="text-slate-500 text-sm font-semibold">{stat.title}</div>
                                        <div className={`text-2xl font-bold mt-1 mb-1 text-slate-800`}>
                                            {formatRupiah(stat.value)}
                                        </div>
                                        <div className="text-xs text-slate-400 font-medium">{stat.sub}</div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Analytics Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <Card className="lg:col-span-2 flex flex-col">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-slate-800 flex items-center gap-2">
                                        <Icon name="bar-chart-2" className="text-blue-600" size={20} />
                                        Analisis Arus Kas
                                    </h3>
                                    <Badge>{getPeriodString()}</Badge>
                                </div>
                                <div className="flex-1 min-h-[300px]">
                                    <ChartComponent 
                                        type="bar" 
                                        data={{
                                            labels: ['Pendapatan', 'HPP (Modal)', 'Beban (Ops+Waste)', 'Laba Bersih'],
                                            datasets: [{
                                                label: 'Total (IDR)',
                                                data: [financeStats.revenue, financeStats.cogs, financeStats.waste + operationalCost, financeStats.netProfit],
                                                backgroundColor: [
                                                    'rgba(16, 185, 129, 0.8)', // Emerald
                                                    'rgba(59, 130, 246, 0.8)', // Blue
                                                    'rgba(244, 63, 94, 0.8)',  // Rose
                                                    'rgba(99, 102, 241, 0.8)'  // Indigo
                                                ],
                                                borderRadius: 6,
                                                barThickness: 40
                                            }]
                                        }}
                                        options={{ 
                                            plugins: { legend: { display: false } },
                                            scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } } }
                                        }}
                                    />
                                </div>
                            </Card>

                            <div className="space-y-6">
                                <Card>
                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <Icon name="activity" className="text-amber-500" size={20} />
                                        Indikator Performa
                                    </h3>
                                    <div className="space-y-4">
                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-slate-500">Gross Margin</span>
                                                <span className="font-bold text-emerald-600">
                                                    {financeStats.revenue > 0 ? ((financeStats.grossProfit / financeStats.revenue) * 100).toFixed(1) : 0}%
                                                </span>
                                            </div>
                                            <div className="w-full bg-slate-200 rounded-full h-2">
                                                <div className="bg-emerald-500 h-2 rounded-full" style={{ width: `${financeStats.revenue > 0 ? Math.min(((financeStats.grossProfit / financeStats.revenue) * 100), 100) : 0}%` }}></div>
                                            </div>
                                        </div>

                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-slate-500">Net Profit Margin</span>
                                                <span className="font-bold text-indigo-600">
                                                    {financeStats.revenue > 0 ? ((financeStats.netProfit / financeStats.revenue) * 100).toFixed(1) : 0}%
                                                </span>
                                            </div>
                                            <div className="w-full bg-slate-200 rounded-full h-2">
                                                <div className="bg-indigo-500 h-2 rounded-full" style={{ width: `${financeStats.revenue > 0 ? Math.min(((financeStats.netProfit / financeStats.revenue) * 100), 100) : 0}%` }}></div>
                                            </div>
                                        </div>

                                        <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 text-center">
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Break Even Point (Ops)</div>
                                            <div className="text-lg font-bold text-slate-700">{formatRupiah(operationalCost)}</div>
                                            <div className="text-[10px] text-slate-400 mt-1">Target minimal laba kotor</div>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        </div>
                    </div>
                );
            };

            const HPPCalculator_Deprecated = () => {
                // Initialize State from LocalStorage
                const [targetQty, setTargetQty] = useState(() => {
                    const saved = localStorage.getItem('fnb_hpp_state');
                    return saved ? (JSON.parse(saved).targetQty || 1) : 1;
                });
                const [components, setComponents] = useState(() => {
                    const saved = localStorage.getItem('fnb_hpp_state');
                    return saved ? (JSON.parse(saved).components || []) : [];
                }); 
                const [extras, setExtras] = useState(() => {
                    const saved = localStorage.getItem('fnb_hpp_state');
                    return saved ? (JSON.parse(saved).extras || []) : [];
                });
                const [desiredMargin, setDesiredMargin] = useState(() => {
                    const saved = localStorage.getItem('fnb_hpp_state');
                    return saved ? (JSON.parse(saved).desiredMargin || 30) : 30;
                });
                const [sellingPrice, setSellingPrice] = useState(() => {
                    const saved = localStorage.getItem('fnb_hpp_state');
                    return saved ? (JSON.parse(saved).sellingPrice || 0) : 0;
                });

                // Persist State to LocalStorage
                useEffect(() => {
                    localStorage.setItem('fnb_hpp_state', JSON.stringify({
                        targetQty, components, extras, desiredMargin, sellingPrice
                    }));
                }, [targetQty, components, extras, desiredMargin, sellingPrice]);

                const addComponent = () => {
                    const firstItem = inventory[0] || {};
                    setComponents([...components, {
                        id: Date.now(),
                        itemId: firstItem.id || "",
                        name: firstItem.name || "Item",
                        price: firstItem.price || 0,
                        unit: firstItem.unit || "pcs",
                        qty: 1
                    }]);
                };

                const updateComponent = (idx, field, value) => {
                    const newComps = [...components];
                    if (field === 'itemId') {
                        const item = inventory.find(i => i.id === value);
                        newComps[idx] = {
                            ...newComps[idx],
                            itemId: value,
                            name: item.name,
                            price: item.price,
                            unit: item.unit
                        };
                    } else {
                        newComps[idx][field] = value;
                    }
                    setComponents(newComps);
                };

                const removeComponent = (idx) => {
                    setComponents(components.filter((_, i) => i !== idx));
                };

                const addExtra = () => {
                    setExtras([...extras, { id: Date.now(), name: "Biaya Lain (Gas/Listrik)", cost: 0 }]);
                };

                const updateExtra = (idx, field, value) => {
                    const newExtras = [...extras];
                    newExtras[idx][field] = value;
                    setExtras(newExtras);
                };

                const removeExtra = (idx) => {
                    setExtras(extras.filter((_, i) => i !== idx));
                };

                // Calculations
                const totalMaterialCost = components.reduce((sum, c) => sum + (c.price * c.qty), 0);
                const totalExtraCost = extras.reduce((sum, e) => sum + e.cost, 0);
                const grandTotal = totalMaterialCost + totalExtraCost;
                const hppPerUnit = targetQty > 0 ? grandTotal / targetQty : 0;
                
                // Simulation Logic
                const suggestedPrice = hppPerUnit > 0 ? hppPerUnit / (1 - (desiredMargin / 100)) : 0;
                const actualMargin = sellingPrice > 0 ? ((sellingPrice - hppPerUnit) / sellingPrice) * 100 : 0;
                const profitPerUnit = sellingPrice - hppPerUnit;

                return (
                    <div className="space-y-6 max-w-5xl mx-auto pb-20">
                        <div className="flex justify-between items-start">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-800">Kalkulator HPP & Profit</h2>
                                <p className="text-gray-500 text-sm">Hitung modal produksi per batch atau satuan</p>
                            </div>
                            <div className="bg-indigo-50 px-4 py-2 rounded-xl border border-indigo-100 flex items-center gap-3">
                                <span className="text-indigo-800 text-sm font-bold">Target Produksi (Qty):</span>
                                <input 
                                    type="number" min="1" 
                                    className="w-20 p-1 text-center font-bold text-lg border border-indigo-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
                                    value={targetQty}
                                    onChange={e => setTargetQty(parseFloat(e.target.value) || 1)}
                                />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            {/* LEFT COLUMN: INPUTS */}
                            <div className="lg:col-span-7 space-y-6">
                                {/* Material Costs */}
                                <Card className="border-emerald-100 bg-emerald-50/30">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-emerald-900 flex items-center gap-2">
                                            <Icon name="package" size={18} className="text-emerald-600" /> Biaya Bahan Baku
                                        </h3>
                                        <Button size="sm" onClick={addComponent} variant="outline" className="text-xs bg-white hover:bg-emerald-50 text-emerald-700 border-emerald-200">
                                            <Icon name="plus" size={14} /> Tambah
                                        </Button>
                                    </div>
                                    <div className="space-y-3">
                                        {components.length === 0 && <p className="text-center text-emerald-400/60 text-sm py-4 italic">Belum ada bahan dipilih</p>}
                                        {components.map((comp, idx) => (
                                            <div key={comp.id} className="bg-white p-3 rounded-xl border border-emerald-100 shadow-sm flex flex-col sm:flex-row gap-2 sm:items-center transition-all hover:border-emerald-300">
                                                <div className="flex-1 flex gap-2 w-full sm:w-auto">
                                                    <select 
                                                        className="flex-1 p-2 text-sm border border-emerald-100 rounded-lg bg-emerald-50/50 focus:ring-2 focus:ring-emerald-500 outline-none"
                                                        value={comp.itemId}
                                                        onChange={e => updateComponent(idx, 'itemId', e.target.value)}
                                                    >
                                                        {inventory.map(i => (
                                                            <option key={i.id} value={i.id}>{i.name} (@ {formatRupiah(i.price)}/{i.unit})</option>
                                                        ))}
                                                    </select>
                                                </div>
                                                <div className="flex justify-between items-center gap-3 w-full sm:w-auto">
                                                    <div className="flex items-center gap-2">
                                                        <input 
                                                            type="number" step="any" min="0"
                                                            className="w-20 p-2 text-center text-sm border border-emerald-100 rounded-lg bg-emerald-50/50 focus:ring-2 focus:ring-emerald-500 outline-none font-medium"
                                                            value={comp.qty}
                                                            onChange={e => updateComponent(idx, 'qty', parseFloat(e.target.value))}
                                                        />
                                                        <span className="text-xs text-emerald-600 font-bold w-8">{comp.unit}</span>
                                                    </div>
                                                    <div className="flex items-center gap-3 min-w-[100px] justify-end">
                                                        <span className="font-bold text-emerald-800 text-sm">{formatRupiah(comp.price * comp.qty)}</span>
                                                        <button onClick={() => removeComponent(idx)} className="text-rose-400 hover:text-rose-600 p-1.5 hover:bg-rose-50 rounded-lg transition-colors">
                                                            <Icon name="trash-2" size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-4 pt-3 border-t border-emerald-200 flex justify-between items-center">
                                        <span className="text-sm font-bold text-emerald-700 uppercase tracking-wide">Subtotal Bahan</span>
                                        <span className="font-bold text-emerald-700 text-lg">{formatRupiah(totalMaterialCost)}</span>
                                    </div>
                                </Card>

                                {/* Overhead Costs */}
                                <Card className="border-amber-100 bg-amber-50/30">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-amber-900 flex items-center gap-2">
                                            <Icon name="zap" size={18} className="text-amber-500" /> Biaya Operasional / Lainnya
                                        </h3>
                                        <Button size="sm" onClick={addExtra} variant="outline" className="text-xs bg-white hover:bg-amber-50 text-amber-700 border-amber-200">
                                            <Icon name="plus" size={14} /> Tambah
                                        </Button>
                                    </div>
                                    <div className="space-y-3">
                                        {extras.length === 0 && <p className="text-center text-amber-400/60 text-sm py-4 italic">Tidak ada biaya tambahan</p>}
                                        {extras.map((extra, idx) => (
                                            <div key={extra.id} className="bg-white p-3 rounded-xl border border-amber-100 shadow-sm flex flex-col sm:flex-row gap-2 sm:items-center transition-all hover:border-amber-300">
                                                <input 
                                                    type="text" 
                                                    className="flex-1 p-2 text-sm border border-amber-100 rounded-lg bg-amber-50/50 focus:ring-2 focus:ring-amber-500 outline-none"
                                                    value={extra.name}
                                                    onChange={e => updateExtra(idx, 'name', e.target.value)}
                                                    placeholder="Nama Biaya (mis: Listrik, Packaging)"
                                                />
                                                <div className="flex items-center gap-2 w-full sm:w-auto">
                                                    <div className="relative w-full sm:w-32">
                                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-amber-500 text-xs font-bold">Rp</span>
                                                        <input 
                                                            type="number" step="any" min="0"
                                                            className="w-full pl-8 pr-3 py-2 text-right text-sm border border-amber-100 rounded-lg bg-amber-50/50 focus:ring-2 focus:ring-amber-500 outline-none font-bold text-amber-900"
                                                            value={extra.cost}
                                                            onChange={e => updateExtra(idx, 'cost', parseFloat(e.target.value))}
                                                        />
                                                    </div>
                                                    <button onClick={() => removeExtra(idx)} className="text-rose-400 hover:text-rose-600 p-1.5 hover:bg-rose-50 rounded-lg transition-colors">
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-4 pt-3 border-t border-amber-200 flex justify-between items-center">
                                        <span className="text-sm font-bold text-amber-700 uppercase tracking-wide">Subtotal Ops</span>
                                        <span className="font-bold text-amber-700 text-lg">{formatRupiah(totalExtraCost)}</span>
                                    </div>
                                </Card>
                            </div>

                            {/* RIGHT COLUMN: RESULTS */}
                            <div className="lg:col-span-5 space-y-6">
                                <div className="bg-slate-800 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-4 opacity-10">
                                        <Icon name="calculator" size={100} />
                                    </div>
                                    <div className="relative z-10">
                                        <div className="mb-6">
                                            <div className="text-slate-400 text-sm font-medium uppercase tracking-wider mb-1">Total Modal (Batch)</div>
                                            <div className="text-3xl font-bold">{formatRupiah(grandTotal)}</div>
                                        </div>
                                        <div className="pt-6 border-t border-slate-700">
                                            <div className="text-emerald-400 text-sm font-bold uppercase tracking-wider mb-1">HPP Per Unit (Satuan)</div>
                                            <div className="text-4xl font-bold">{formatRupiah(hppPerUnit)}</div>
                                            <div className="text-slate-400 text-xs mt-2">
                                                Dari {targetQty} unit yang diproduksi
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <Card className="border-blue-100 bg-blue-50/50">
                                    <h3 className="font-bold text-blue-900 mb-4 flex items-center gap-2">
                                        <Icon name="trending-up" size={18} /> Simulator Profit
                                    </h3>
                                    
                                    {/* Scenario A: By Margin */}
                                    <div className="mb-6">
                                        <label className="text-xs font-bold text-blue-800 uppercase mb-1 block">A. Tentukan Margin, Cari Harga Jual</label>
                                        <div className="flex gap-2 mb-2">
                                            <div className="relative flex-1">
                                                <input 
                                                    type="number" 
                                                    className="w-full p-2 border border-blue-200 rounded-lg text-center font-bold text-blue-900"
                                                    value={desiredMargin}
                                                    onChange={e => setDesiredMargin(parseFloat(e.target.value))}
                                                />
                                                <span className="absolute right-3 top-1/2 -translate-y-1/2 text-blue-400 font-bold">%</span>
                                            </div>
                                            <div className="flex items-center text-blue-400"><Icon name="arrow-right" size={16} /></div>
                                            <div className="flex-1 bg-white p-2 border border-blue-200 rounded-lg text-center font-bold text-emerald-600">
                                                {formatRupiah(suggestedPrice)}
                                            </div>
                                        </div>
                                        <p className="text-[10px] text-blue-600/70">
                                            *Harga jual minimal agar margin tercapai.
                                        </p>
                                    </div>

                                    <div className="h-px bg-blue-200 my-4"></div>

                                    {/* Scenario B: By Price */}
                                    <div>
                                        <label className="text-xs font-bold text-blue-800 uppercase mb-1 block">B. Cek Profit dari Harga Jual</label>
                                        <div className="relative mb-3">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-blue-400 font-bold text-xs">Rp</span>
                                            <input 
                                                type="number" 
                                                className="w-full pl-8 pr-3 py-2 border border-blue-200 rounded-lg font-bold text-gray-700 outline-none focus:ring-2 focus:ring-blue-500"
                                                placeholder="Masukan Harga Jual..."
                                                value={sellingPrice || ''}
                                                onChange={e => setSellingPrice(parseFloat(e.target.value))}
                                            />
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className={`p-3 rounded-lg border text-center ${actualMargin > 0 ? 'bg-emerald-100 border-emerald-200 text-emerald-800' : 'bg-rose-100 border-rose-200 text-rose-800'}`}>
                                                <div className="text-[10px] font-bold uppercase mb-1">Net Profit</div>
                                                <div className="font-bold">{formatRupiah(profitPerUnit)}</div>
                                            </div>
                                            <div className={`p-3 rounded-lg border text-center ${actualMargin > 0 ? 'bg-emerald-100 border-emerald-200 text-emerald-800' : 'bg-rose-100 border-rose-200 text-rose-800'}`}>
                                                <div className="text-[10px] font-bold uppercase mb-1">Margin</div>
                                                <div className="font-bold">{actualMargin.toFixed(1)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </Card>
                            </div>
                        </div>
                    </div>
                );
            };

            const SettingsView = () => (
                <div className="max-w-4xl mx-auto space-y-8">
                    <Card>
                        <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                            <Icon name="database" className="text-blue-600" />
                            Manajemen Data
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="p-5 bg-blue-50 border border-blue-100 rounded-xl flex flex-col justify-between h-full hover:shadow-md transition-shadow">
                                <div className="mb-4">
                                    <div className="bg-white w-10 h-10 rounded-lg flex items-center justify-center text-blue-600 mb-3 shadow-sm">
                                        <Icon name="download" size={20} />
                                    </div>
                                    <h3 className="font-bold text-blue-900 text-lg">Backup Data</h3>
                                    <p className="text-sm text-blue-700/80 mt-1 leading-relaxed">
                                        Simpan salinan database (Stok, Resep, History) ke file JSON untuk keamanan.
                                    </p>
                                </div>
                                <Button onClick={handleExportData} className="w-full justify-center bg-blue-600 hover:bg-blue-700 text-white shadow-blue-200">
                                    Download Backup
                                </Button>
                            </div>

                            <div className="p-5 bg-emerald-50 border border-emerald-100 rounded-xl flex flex-col justify-between h-full hover:shadow-md transition-shadow">
                                <div className="mb-4">
                                    <div className="bg-white w-10 h-10 rounded-lg flex items-center justify-center text-emerald-600 mb-3 shadow-sm">
                                        <Icon name="upload" size={20} />
                                    </div>
                                    <h3 className="font-bold text-emerald-900 text-lg">Restore Data</h3>
                                    <p className="text-sm text-emerald-700/80 mt-1 leading-relaxed">
                                        Pulihkan data dari file backup JSON yang tersimpan sebelumnya.
                                    </p>
                                </div>
                                <div>
                                    <input 
                                        type="file" 
                                        accept=".json" 
                                        id="import-file" 
                                        className="hidden" 
                                        onChange={handleImportData} 
                                    />
                                    <label htmlFor="import-file" className="cursor-pointer w-full py-2 bg-white text-emerald-700 border border-emerald-200 rounded-lg font-bold hover:bg-emerald-100 transition-colors flex items-center justify-center gap-2 shadow-sm">
                                        <Icon name="file-up" size={18} /> Pilih File Backup
                                    </label>
                                </div>
                            </div>
                        </div>
                    </Card>

                    {user.role === 'owner' && (
                        <Card className="border-rose-100 bg-rose-50/30">
                            <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
                                <div>
                                    <h2 className="text-xl font-bold text-rose-800 mb-2 flex items-center gap-2">
                                        <Icon name="alert-triangle" className="text-rose-600" />
                                        Danger Zone
                                    </h2>
                                    <p className="text-rose-600/80 text-sm max-w-lg">
                                        Tindakan ini akan menghapus <strong>seluruh data</strong> sistem secara permanen. 
                                        Pastikan Anda sudah melakukan backup sebelum melanjutkan.
                                    </p>
                                </div>
                                <Button variant="danger" onClick={handleResetData} className="w-full md:w-auto px-6 py-3 bg-rose-600 hover:bg-rose-700 text-white border-0 shadow-lg shadow-rose-200">
                                    <Icon name="trash-2" size={18} /> Factory Reset
                                </Button>
                            </div>
                        </Card>
                    )}
                </div>
            );

            const ItemForm_Deprecated = () => {
                const [form, setForm] = useState(editingItem.id ? editingItem : {
                    name: '', category: 'Bahan Kering', stock: 0, unit: 'kg', price: 0, minStock: 5
                });

                const handleSubmit = (e) => {
                    e.preventDefault();
                    handleSaveItem({ ...form, stock: parseFloat(form.stock), price: parseFloat(form.price), minStock: parseFloat(form.minStock) });
                };

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium mb-1">Nama Bahan</label>
                            <input type="text" required className="w-full p-2 border rounded-lg" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Kategori</label>
                                <select className="w-full p-2 border rounded-lg" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                                    {CATEGORIES.map(c => <option key={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Satuan</label>
                                <select className="w-full p-2 border rounded-lg" value={form.unit} onChange={e => setForm({...form, unit: e.target.value})}>
                                    {UNITS.map(u => <option key={u}>{u}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-1">Stok Awal</label>
                                <input type="number" step="0.001" required className="w-full p-2 border rounded-lg" value={form.stock} onChange={e => setForm({...form, stock: e.target.value})} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">Min. Stok (Alert)</label>
                                <input type="number" step="0.001" required className="w-full p-2 border rounded-lg" value={form.minStock} onChange={e => setForm({...form, minStock: e.target.value})} />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">Harga per Unit (IDR)</label>
                            <input type="number" required className="w-full p-2 border rounded-lg" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                        </div>
                        <div className="pt-4 flex gap-2">
                            <Button type="submit" className="flex-1 justify-center">Simpan</Button>
                            <Button variant="secondary" onClick={() => setShowFormModal(false)}>Batal</Button>
                        </div>
                    </form>
                );
            };

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden font-sans">
                    {!user && <LoginScreen onLogin={handleLogin} />}
                    
                    {user && (
                        <>
                            <Sidebar />
                            
                            <main className={`flex-1 overflow-hidden flex flex-col transition-all duration-300 ml-0 md:${isSidebarOpen ? 'ml-64' : 'ml-20'}`}>
                                {/* Header Mobile */}
                                <div className="md:hidden bg-white p-4 border-b flex items-center justify-between shadow-sm z-20 relative">
                                     <div className="flex items-center gap-2">
                                         <div className={`${user.role === 'owner' ? 'bg-emerald-500' : 'bg-indigo-600'} p-1.5 rounded-lg`}>
                                             <Icon name="chef-hat" className="text-white" size={20} />
                                         </div>
                                         <span className="font-bold text-lg text-slate-800">KitchenPro</span>
                                     </div>
                                     <button onClick={() => setIsSidebarOpen(true)} className="p-2 hover:bg-gray-100 rounded-lg">
                                         <Icon name="menu" size={24} className="text-gray-700" />
                                     </button>
                                </div>

                                <div className="flex-1 overflow-auto p-4 md:p-8">
                                    <div className="max-w-7xl mx-auto">
                                        <header className="mb-8">
                                            <h1 className="text-2xl md:text-3xl font-bold text-slate-800">
                                                {view === 'dashboard' && 'Kitchen Dashboard'}
                                                {view === 'list' && 'Inventory Bahan Baku'}
                                                {view === 'products' && 'Manajemen Menu Resep'}
                                                {view === 'hpp' && 'Kalkulator HPP'}
                                                {view === 'usage' && 'Pencatatan Pemakaian Bahan'}
                                                {view === 'restock' && 'Purchase Order (Pengadaan)'}
                                                {view === 'finance' && 'Laporan Keuangan'}
                                                {view === 'settings' && 'Pengaturan Sistem'}
                                            </h1>
                                            <p className="text-slate-500 mt-1">
                                                {view === 'dashboard' && 'Monitor stok dan aktivitas dapur anda.'}
                                                {view === 'list' && 'Kelola database semua bahan makanan & minuman.'}
                                                {view === 'products' && 'Atur resep, harga jual, dan hitung profit margin.'}
                                                {view === 'hpp' && 'Simulasi biaya produksi dan penetapan harga jual.'}
                                                {view === 'usage' && 'Input pemakaian harian atau barang rusak.'}
                                                {view === 'restock' && 'Siapkan dan kirim order belanja ke supplier.'}
                                                {view === 'finance' && 'Laporan profit, omzet, dan biaya operasional.'}
                                                {view === 'settings' && 'Backup data dan konfigurasi sistem.'}
                                            </p>
                                        </header>

                                        {view === 'dashboard' && <Dashboard />}
                                        {view === 'list' && <InventoryList 
                                            inventory={inventory}
                                            products={products}
                                            searchTerm={searchTerm}
                                            setSearchTerm={setSearchTerm}
                                            user={user}
                                            canEdit={canEdit}
                                            setEditingItem={setEditingItem}
                                            setShowFormModal={setShowFormModal}
                                            handleDelete={handleDelete}
                                            setInventory={setInventory}
                                            setUsageLog={setUsageLog}
                                            usageLog={usageLog}
                                            showToast={showToast}
                                            formatRupiah={formatRupiah}
                                            setView={setView}
                                        />}
                                        {view === 'products' && <ProductView 
                                            products={products} 
                                            setProducts={setProducts} 
                                            inventory={inventory} 
                                            showToast={showToast} 
                                            canEdit={canEdit} 
                                            calculateHPP={calculateHPP} 
                                            handleProduce={handleProduce}
                                        />}
                                        {view === 'hpp' && <HPPCalculator 
                                            inventory={inventory} 
                                            products={products} 
                                            formatRupiah={formatRupiah} 
                                            calculateHPP={calculateHPP} 
                                        />}
                                        {view === 'usage' && <UsageView 
                                            inventory={inventory} 
                                            user={user} 
                                            handleRecordUsage={handleRecordUsage} 
                                            showToast={showToast} 
                                            setView={setView} 
                                            usageLog={usageLog}
                                        />}
                                        {view === 'restock' && <RestockView 
                                            inventory={inventory} 
                                            products={products} 
                                            user={user} 
                                            showToast={showToast} 
                                            requests={requests} 
                                            setRequests={setRequests} 
                                            setInventory={setInventory} 
                                            restockCart={restockCart} 
                                            setRestockCart={setRestockCart} 
                                            formatRupiah={formatRupiah} 
                                            formatDate={formatDate} 
                                            handleSendRestock={handleSendRestock} 
                                        />}
                                        {view === 'finance' && <FinanceView 
                                            usageLog={usageLog} 
                                            requests={requests} 
                                            inventory={inventory} 
                                            products={products} 
                                            user={user} 
                                            formatRupiah={formatRupiah} 
                                            formatDate={formatDate} 
                                        />}
                                        {view === 'settings' && <SettingsView />}
                                    </div>
                                </div>
                            </main>

                            <Modal isOpen={showFormModal} onClose={() => setShowFormModal(false)} title={editingItem?.id ? "Edit Bahan" : "Tambah Bahan Baru"}>
                                <ItemForm 
                                    editingItem={editingItem} 
                                    handleSaveItem={handleSaveItem} 
                                    setShowFormModal={setShowFormModal} 
                                />
                            </Modal>
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        function App() {
            return (
                <ToastProvider>
                    <KitchenPro />
                </ToastProvider>
            );
        }
        root.render(<App />);
    </script>
</body>
</html>
